<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResumeBuilder Pro - Create Professional Resumes</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Open Sans', sans-serif; }
        .dragging { opacity: 0.5; transform: scale(1.02); }
        .drag-over { border: 2px dashed #3b82f6 !important; background: #eff6ff !important; }
        .section-handle, .item-handle { cursor: grab; }
        .section-handle:active, .item-handle:active { cursor: grabbing; }
        .item-handle { opacity: 0.4; transition: opacity 0.2s; }
        .item-card:hover .item-handle { opacity: 1; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .score-ring { transition: stroke-dashoffset 0.5s ease; }
        .resume-preview { font-size: 11px; line-height: 1.4; }
        .resume-preview h1 { font-size: 20px; }
        .resume-preview h2 { font-size: 13px; }
        .resume-preview h3 { font-size: 12px; }
        .divider-line { border-bottom: 1px solid #333; margin: 4px 0; }
        .divider-double { border-bottom: 3px double #333; margin: 4px 0; }
        .divider-dashed { border-bottom: 1px dashed #333; margin: 4px 0; }
        .divider-dotted { border-bottom: 2px dotted #333; margin: 4px 0; }
        .divider-thick { border-bottom: 2px solid #333; margin: 4px 0; }
        .divider-none { margin: 4px 0; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .resume-container { 
                box-shadow: none !important; 
                margin: 0 !important;
                padding: 0 !important;
            }
            #resumePreview {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 15mm !important;
                box-shadow: none !important;
            }
            @page {
                size: A4;
                margin: 0;
            }
        }
        .tooltip { position: relative; }
        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
        }
        .item-card { transition: all 0.2s ease; }
        .item-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .item-disabled { opacity: 0.5; }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .contact-icon { display: inline-flex; align-items: center; gap: 4px; }
        .contact-icon i { font-size: 0.85em; }
        
        /* Editable resume styles */
        .resume-editable [contenteditable="true"]:hover {
            outline: 1px dashed #3b82f6;
            cursor: text;
        }
        .resume-editable [contenteditable="true"]:focus {
            outline: 2px solid #3b82f6;
            background: #f0f9ff;
        }
        
        /* Formatting toolbar */
        .format-toolbar {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            gap: 4px;
        }
        .format-toolbar.visible {
            display: flex;
        }
        .format-toolbar button {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
        }
        .format-toolbar button:hover {
            background: #f3f4f6;
        }
        .format-toolbar button.active {
            background: #dbeafe;
            color: #2563eb;
        }
        .format-toolbar .separator {
            width: 1px;
            height: 24px;
            background: #e5e7eb;
            margin: 0 4px;
        }
        .format-toolbar select {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* Rich text editor for modals */
        .rich-text-editor {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            background: white;
            outline: none;
        }
        .rich-text-editor:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .rich-text-editor p {
            margin: 0 0 8px 0;
        }
        .rich-text-editor p:last-child {
            margin-bottom: 0;
        }
        .rich-text-toolbar {
            display: flex;
            gap: 4px;
            padding: 6px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
        }
        .rich-text-toolbar button {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
        }
        .rich-text-toolbar button:hover {
            background: #e5e7eb;
        }
        .rich-text-toolbar button.active {
            background: #dbeafe;
            color: #2563eb;
        }
        .rich-text-toolbar .separator {
            width: 1px;
            height: 24px;
            background: #e5e7eb;
            margin: 0 4px;
        }
        
        /* Page break indicator */
        .page-break-indicator {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 2px dashed #ef4444;
            pointer-events: none;
            z-index: 10;
        }
        .page-break-indicator::before {
            content: 'Page 1 ends here';
            position: absolute;
            right: 0;
            top: -20px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .page-break-indicator.page-2::before {
            content: 'Page 2 ends here';
        }
        .page-break-indicator.page-3::before {
            content: 'Page 3 ends here';
        }
        .resume-container {
            position: relative;
        }
        .page-overflow-warning {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-width: 300px;
        }
        .page-info-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Formatting Toolbar -->
    <div id="formatToolbar" class="format-toolbar">
        <button onclick="formatText('bold')" title="Bold (Ctrl+B)" id="btn-bold">
            <i class="fas fa-bold"></i>
        </button>
        <button onclick="formatText('italic')" title="Italic (Ctrl+I)" id="btn-italic">
            <i class="fas fa-italic"></i>
        </button>
        <button onclick="formatText('underline')" title="Underline (Ctrl+U)" id="btn-underline">
            <i class="fas fa-underline"></i>
        </button>
        <div class="separator"></div>
        <select onchange="changeFontSize(this.value)" id="fontSizeSelect" title="Font Size">
            <option value="">Size</option>
            <option value="1">8px</option>
            <option value="2">10px</option>
            <option value="3">12px</option>
            <option value="4">14px</option>
            <option value="5">18px</option>
            <option value="6">24px</option>
            <option value="7">36px</option>
        </select>
        <div class="separator"></div>
        <button onclick="formatText('removeFormat')" title="Clear Formatting">
            <i class="fas fa-eraser"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50 no-print">
        <div class="max-w-full mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-alt text-white text-lg"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">ResumeBuilder <span class="text-blue-500">Pro</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="autoSaveIndicator" class="text-xs text-gray-400 flex items-center gap-1">
                    <i class="fas fa-cloud text-green-500"></i>
                    <span>Auto-saved</span>
                </div>
                <button onclick="openSaveModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg flex items-center gap-2">
                    <i class="fas fa-save"></i> Save
                </button>
                <button onclick="openLoadModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg flex items-center gap-2">
                    <i class="fas fa-folder-open"></i> My Resumes
                </button>
                <div class="relative">
                    <button onclick="toggleExportMenu()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                        <i class="fas fa-download"></i> Export
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="exportMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border overflow-hidden">
                        <button onclick="exportToPDF()" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3">
                            <i class="fas fa-file-pdf text-red-500"></i> 
                            <div>
                                <div class="font-medium">Download PDF</div>
                                <div class="text-xs text-gray-400">High quality export</div>
                            </div>
                        </button>
                        <button onclick="printToPDF()" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 border-t">
                            <i class="fas fa-print text-blue-500"></i>
                            <div>
                                <div class="font-medium">Print / Save as PDF</div>
                                <div class="text-xs text-gray-400">Use browser print dialog</div>
                            </div>
                        </button>
                        <button onclick="exportToHTML()" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 border-t">
                            <i class="fas fa-code text-orange-500"></i> Export as HTML
                        </button>
                        <button onclick="exportToTXT()" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 border-t">
                            <i class="fas fa-file-alt text-gray-500"></i> Export as TXT
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex pt-16 min-h-screen">
        <!-- Left Sidebar - Editor -->
        <div class="w-1/2 bg-white border-r overflow-y-auto no-print" style="height: calc(100vh - 64px);">
            <!-- Tabs -->
            <div class="flex border-b sticky top-0 bg-white z-10">
                <button onclick="switchTab('content')" id="tab-content" class="flex-1 px-4 py-3 text-sm tab-active">
                    <i class="fas fa-edit mr-2"></i>Content
                </button>
                <button onclick="switchTab('design')" id="tab-design" class="flex-1 px-4 py-3 text-sm text-gray-500 hover:text-gray-700">
                    <i class="fas fa-palette mr-2"></i>Design
                </button>
                <button onclick="switchTab('score')" id="tab-score" class="flex-1 px-4 py-3 text-sm text-gray-500 hover:text-gray-700">
                    <i class="fas fa-chart-line mr-2"></i>Score
                </button>
            </div>

            <!-- Content Tab -->
            <div id="panel-content" class="p-4">
                <!-- Edit Mode Toggle -->
                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="editModeToggle" onchange="toggleEditMode(this.checked)" class="w-5 h-5 rounded text-blue-500">
                        <div>
                            <span class="font-medium text-blue-800">Direct Edit Mode</span>
                            <p class="text-xs text-blue-600">Click on the resume preview to edit text directly (bold, italic, etc.)</p>
                        </div>
                    </label>
                </div>

                <!-- Section Accordion -->
                <div class="space-y-3">
                    <!-- Personal Info Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('personal')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-user text-blue-500"></i>
                                <span class="font-medium">Personal Information</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-personal" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-personal"></i>
                            </div>
                        </button>
                        <div id="section-personal" class="p-4 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Full Name *</label>
                                    <input type="text" id="fullName" oninput="updatePreview()" placeholder="John Doe" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Job Title</label>
                                    <input type="text" id="jobTitle" oninput="updatePreview()" placeholder="Software Engineer" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Email *</label>
                                    <input type="email" id="email" oninput="updatePreview()" placeholder="john@example.com" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Phone *</label>
                                    <input type="tel" id="phone" oninput="updatePreview()" placeholder="+1 (555) 123-4567" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Location</label>
                                    <input type="text" id="location" oninput="updatePreview()" placeholder="New York, NY" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">LinkedIn</label>
                                    <input type="text" id="linkedin" oninput="updatePreview()" placeholder="linkedin.com/in/johndoe" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Website/Portfolio</label>
                                    <input type="text" id="website" oninput="updatePreview()" placeholder="johndoe.com" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">GitHub</label>
                                    <input type="text" id="github" oninput="updatePreview()" placeholder="github.com/johndoe" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('summary')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-align-left text-purple-500"></i>
                                <span class="font-medium">Professional Summary</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-summary" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-summary"></i>
                            </div>
                        </button>
                        <div id="section-summary" class="p-4 hidden">
                            <label class="block text-sm text-gray-600 mb-1">Summary (2-4 sentences)</label>
                            <textarea id="summary" oninput="updatePreview(); document.getElementById('summaryCount').textContent = this.value.length;" rows="4" placeholder="Results-driven software engineer with 5+ years of experience..." class="w-full px-3 py-2 border rounded-lg text-sm"></textarea>
                            <p class="text-xs text-gray-400 mt-1"><span id="summaryCount">0</span>/300 characters recommended</p>
                        </div>
                    </div>

                    <!-- Experience Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('experience')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-briefcase text-green-500"></i>
                                <span class="font-medium">Work Experience</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-experience" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-experience"></i>
                            </div>
                        </button>
                        <div id="section-experience" class="p-4 hidden">
                            <div id="experienceList" class="space-y-3 mb-3"></div>
                            <button onclick="addExperience()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Add Experience
                            </button>
                        </div>
                    </div>

                    <!-- Education Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('education')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-graduation-cap text-yellow-500"></i>
                                <span class="font-medium">Education</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-education" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-education"></i>
                            </div>
                        </button>
                        <div id="section-education" class="p-4 hidden">
                            <div id="educationList" class="space-y-3 mb-3"></div>
                            <button onclick="addEducation()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Add Education
                            </button>
                        </div>
                    </div>

                    <!-- Skills Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('skills')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-cogs text-red-500"></i>
                                <span class="font-medium">Skills</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-skills" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-skills"></i>
                            </div>
                        </button>
                        <div id="section-skills" class="p-4 hidden">
                            <div id="skillsList" class="space-y-3 mb-3"></div>
                            <button onclick="addSkillCategory()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Add Skill Category
                            </button>
                        </div>
                    </div>

                    <!-- Projects Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('projects')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-project-diagram text-indigo-500"></i>
                                <span class="font-medium">Projects</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-projects" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-projects"></i>
                            </div>
                        </button>
                        <div id="section-projects" class="p-4 hidden">
                            <div id="projectsList" class="space-y-3 mb-3"></div>
                            <button onclick="addProject()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Add Project
                            </button>
                        </div>
                    </div>

                    <!-- Certifications Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('certifications')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-certificate text-orange-500"></i>
                                <span class="font-medium">Certifications</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-certifications" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-certifications"></i>
                            </div>
                        </button>
                        <div id="section-certifications" class="p-4 hidden">
                            <div id="certificationsList" class="space-y-3 mb-3"></div>
                            <button onclick="addCertification()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Add Certification
                            </button>
                        </div>
                    </div>

                    <!-- Languages Section -->
                    <div class="border rounded-lg overflow-hidden">
                        <button onclick="toggleSection('languages')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-language text-teal-500"></i>
                                <span class="font-medium">Languages</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="score-languages" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">0%</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-languages"></i>
                            </div>
                        </button>
                        <div id="section-languages" class="p-4 hidden">
                            <div id="languagesList" class="space-y-3 mb-3"></div>
                            <button onclick="addLanguage()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Add Language
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Design Tab -->
            <div id="panel-design" class="p-4 hidden">
                <div class="space-y-6">
                    <!-- Font Selection -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-font mr-2"></i>Font Family</h3>
                        <select id="fontFamily" onchange="updateDesign()" class="w-full px-3 py-2 border rounded-lg">
                            <option value="'Open Sans', sans-serif">Open Sans</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Lato', sans-serif">Lato</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Merriweather', serif">Merriweather</option>
                            <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="Georgia, serif">Georgia</option>
                        </select>
                    </div>

                    <!-- Font Size -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-text-height mr-2"></i>Font Size</h3>
                        <div class="flex items-center gap-3">
                            <input type="range" id="fontSize" min="9" max="14" value="11" onchange="updateDesign()" class="flex-1">
                            <span id="fontSizeValue" class="text-sm text-gray-500 w-12">11px</span>
                        </div>
                    </div>

                    <!-- Line Spacing -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-arrows-alt-v mr-2"></i>Line Spacing</h3>
                        <div class="flex items-center gap-3">
                            <input type="range" id="lineSpacing" min="1" max="2" step="0.1" value="1.4" onchange="updateDesign()" class="flex-1">
                            <span id="lineSpacingValue" class="text-sm text-gray-500 w-12">1.4</span>
                        </div>
                    </div>

                    <!-- Margins -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-arrows-alt mr-2"></i>Page Margins</h3>
                        <div class="flex items-center gap-3">
                            <input type="range" id="margins" min="10" max="50" value="25" onchange="updateDesign()" class="flex-1">
                            <span id="marginsValue" class="text-sm text-gray-500 w-12">20px</span>
                        </div>
                    </div>

                    <!-- Section Spacing -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-expand-arrows-alt mr-2"></i>Section Spacing</h3>
                        <div class="flex items-center gap-3">
                            <input type="range" id="sectionSpacing" min="5" max="25" value="12" onchange="updateDesign()" class="flex-1">
                            <span id="sectionSpacingValue" class="text-sm text-gray-500 w-12">12px</span>
                        </div>
                    </div>

                    <!-- Section Titles -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-heading mr-2"></i>Section Titles</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Professional Summary</label>
                                <input type="text" id="title-summary" value="Professional Summary" onchange="updateSectionTitle('summary', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Work Experience</label>
                                <input type="text" id="title-experience" value="Work Experience" onchange="updateSectionTitle('experience', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Education</label>
                                <input type="text" id="title-education" value="Education" onchange="updateSectionTitle('education', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Skills</label>
                                <input type="text" id="title-skills" value="Skills" onchange="updateSectionTitle('skills', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Projects</label>
                                <input type="text" id="title-projects" value="Projects" onchange="updateSectionTitle('projects', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Certifications</label>
                                <input type="text" id="title-certifications" value="Certifications" onchange="updateSectionTitle('certifications', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Languages</label>
                                <input type="text" id="title-languages" value="Languages" onchange="updateSectionTitle('languages', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Divider Style -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-minus mr-2"></i>Section Dividers</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setDivider('none')" class="divider-btn p-3 border rounded-lg hover:bg-gray-50 text-center text-sm" data-divider="none">
                                None
                            </button>
                            <button onclick="setDivider('line')" class="divider-btn p-3 border rounded-lg hover:bg-gray-50 text-center text-sm border-blue-500 bg-blue-50" data-divider="line">
                                Line
                            </button>
                            <button onclick="setDivider('thick')" class="divider-btn p-3 border rounded-lg hover:bg-gray-50 text-center text-sm" data-divider="thick">
                                Thick
                            </button>
                            <button onclick="setDivider('double')" class="divider-btn p-3 border rounded-lg hover:bg-gray-50 text-center text-sm" data-divider="double">
                                Double
                            </button>
                            <button onclick="setDivider('dashed')" class="divider-btn p-3 border rounded-lg hover:bg-gray-50 text-center text-sm" data-divider="dashed">
                                Dashed
                            </button>
                            <button onclick="setDivider('dotted')" class="divider-btn p-3 border rounded-lg hover:bg-gray-50 text-center text-sm" data-divider="dotted">
                                Dotted
                            </button>
                        </div>
                    </div>

                    <!-- Layout -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-columns mr-2"></i>Layout Style</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setLayout('single')" class="layout-btn p-4 border rounded-lg hover:bg-gray-50 border-blue-500 bg-blue-50" data-layout="single">
                                <div class="w-full h-16 border-2 border-gray-300 rounded flex flex-col p-1 gap-1">
                                    <div class="w-full h-2 bg-gray-300 rounded"></div>
                                    <div class="w-full h-2 bg-gray-200 rounded"></div>
                                    <div class="w-full h-2 bg-gray-200 rounded"></div>
                                </div>
                                <p class="text-xs mt-2 text-center">Single Column</p>
                            </button>
                            <button onclick="setLayout('compact')" class="layout-btn p-4 border rounded-lg hover:bg-gray-50" data-layout="compact">
                                <div class="w-full h-16 border-2 border-gray-300 rounded flex flex-col p-1 gap-0.5">
                                    <div class="w-full h-1.5 bg-gray-300 rounded"></div>
                                    <div class="w-full h-1.5 bg-gray-200 rounded"></div>
                                    <div class="w-full h-1.5 bg-gray-200 rounded"></div>
                                    <div class="w-full h-1.5 bg-gray-200 rounded"></div>
                                </div>
                                <p class="text-xs mt-2 text-center">Compact</p>
                            </button>
                        </div>
                    </div>

                    <!-- Accent Color -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-palette mr-2"></i>Accent Color</h3>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="setAccentColor('#000000')" class="w-8 h-8 rounded-full bg-black border-2 border-gray-300 hover:scale-110 transition-transform"></button>
                            <button onclick="setAccentColor('#1e40af')" class="w-8 h-8 rounded-full bg-blue-800 border-2 border-transparent hover:scale-110 transition-transform"></button>
                            <button onclick="setAccentColor('#166534')" class="w-8 h-8 rounded-full bg-green-800 border-2 border-transparent hover:scale-110 transition-transform"></button>
                            <button onclick="setAccentColor('#991b1b')" class="w-8 h-8 rounded-full bg-red-800 border-2 border-transparent hover:scale-110 transition-transform"></button>
                            <button onclick="setAccentColor('#6b21a8')" class="w-8 h-8 rounded-full bg-purple-800 border-2 border-transparent hover:scale-110 transition-transform"></button>
                            <button onclick="setAccentColor('#0f766e')" class="w-8 h-8 rounded-full bg-teal-700 border-2 border-transparent hover:scale-110 transition-transform"></button>
                        </div>
                    </div>

                    <!-- Section Order -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-sort mr-2"></i>Section Order (Drag to Reorder)</h3>
                        <div id="sectionOrder" class="space-y-2">
                            <!-- Dynamically populated -->
                        </div>
                    </div>

                    <!-- Auto-fit Section -->
                    <div class="border-t pt-6">
                        <h3 class="font-medium text-gray-700 mb-3"><i class="fas fa-magic mr-2"></i>Page Optimization</h3>
                        <p class="text-sm text-gray-500 mb-3">Automatically adjust settings to fit your resume on one page.</p>
                        <button onclick="autoFitToPage()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 flex items-center justify-center gap-2 font-medium">
                            <i class="fas fa-compress-alt"></i> Auto-fit to One Page
                        </button>
                        <p class="text-xs text-gray-400 mt-2 text-center">This will adjust font size, spacing, and margins</p>
                    </div>
                </div>
            </div>

            <!-- Score Tab -->
            <div id="panel-score" class="p-4 hidden">
                <div class="text-center mb-6">
                    <div class="relative inline-block">
                        <svg class="w-32 h-32 transform -rotate-90">
                            <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle id="scoreCircle" cx="64" cy="64" r="56" stroke="#22c55e" stroke-width="8" fill="none" 
                                stroke-dasharray="352" stroke-dashoffset="352" class="score-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="totalScore" class="text-3xl font-bold text-gray-800">0%</span>
                        </div>
                    </div>
                    <p class="text-gray-500 mt-2">Overall Resume Score</p>
                </div>

                <div class="space-y-4" id="scoreBreakdown">
                    <!-- Score breakdown items -->
                </div>

                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-medium text-blue-800 mb-2"><i class="fas fa-lightbulb mr-2"></i>Tips to Improve</h4>
                    <ul id="scoreTips" class="text-sm text-blue-700 space-y-1">
                        <!-- Tips will be populated -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Right Side - Preview -->
        <div class="w-1/2 bg-gray-200 overflow-y-auto p-6" style="height: calc(100vh - 64px);">
            <div class="max-w-[210mm] mx-auto">
                <div id="resumePreview" class="resume-container bg-white shadow-xl resume-preview" style="min-height: 297mm; padding: 20px;">
                    <!-- Resume content will be rendered here -->
                    <div class="text-center text-gray-400 py-20">
                        <i class="fas fa-file-alt text-6xl mb-4"></i>
                        <p>Start filling in your information to see your resume preview</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 id="modalTitle" class="text-lg font-semibold">Edit Item</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="p-4">
                <!-- Modal content will be injected -->
            </div>
            <div class="p-4 border-t flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                <button onclick="saveModalData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button>
            </div>
        </div>
    </div>

    <!-- Save Resume Modal -->
    <div id="saveModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-semibold">Save Resume</h3>
                <button onclick="closeSaveModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Resume Name</label>
                <input type="text" id="resumeName" class="w-full px-3 py-2 border rounded-lg" placeholder="My Resume">
                <p class="text-xs text-gray-400 mt-2">Give your resume a memorable name to find it later.</p>
            </div>
            <div class="p-4 border-t flex justify-end gap-3">
                <button onclick="closeSaveModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                <button onclick="saveResumeWithName()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button>
            </div>
        </div>
    </div>

    <!-- Load Resume Modal -->
    <div id="loadModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-semibold">My Saved Resumes</h3>
                <button onclick="closeLoadModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="savedResumesList" class="p-4 overflow-y-auto flex-1">
                <!-- Saved resumes will be listed here -->
            </div>
            <div class="p-4 border-t">
                <button onclick="closeLoadModal()" class="w-full px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Page Info Badge -->
    <div id="pageInfoBadge" class="page-info-badge no-print">
        <div class="flex items-center gap-2">
            <i class="fas fa-file-alt text-blue-500"></i>
            <span id="pageCount" class="font-medium">1 page</span>
        </div>
        <div class="h-6 w-px bg-gray-200"></div>
        <button onclick="autoFitToPage()" class="text-sm text-blue-500 hover:text-blue-700 font-medium flex items-center gap-1" title="Auto-adjust settings to fit content on one page">
            <i class="fas fa-magic"></i> Auto-fit
        </button>
    </div>

    <!-- Page Overflow Warning -->
    <div id="pageOverflowWarning" class="page-overflow-warning no-print hidden">
        <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-amber-500 mt-0.5"></i>
            <div>
                <p class="font-medium text-amber-800 text-sm">Content exceeds 1 page</p>
                <p class="text-xs text-amber-700 mt-1">Your resume is <span id="overflowPages">2</span> pages. Click Auto-fit to compress.</p>
                <button onclick="autoFitToPage()" class="mt-2 text-xs bg-amber-500 text-white px-3 py-1 rounded hover:bg-amber-600">
                    <i class="fas fa-compress-alt mr-1"></i> Auto-fit to 1 page
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-24 right-4 z-[200] transform translate-y-full opacity-0 transition-all duration-300">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
            <i id="notificationIcon" class="fas fa-check-circle text-green-400"></i>
            <span id="notificationText">Notification message</span>
        </div>
    </div>

    <script>
        // ==================== DATA STORE ====================
        let resumeData = {
            personal: {
                fullName: '',
                jobTitle: '',
                email: '',
                phone: '',
                location: '',
                linkedin: '',
                website: '',
                github: ''
            },
            summary: '',
            experience: [],
            education: [],
            skills: [],
            projects: [],
            certifications: [],
            languages: []
        };

        let designSettings = {
            fontFamily: "'Open Sans', sans-serif",
            fontSize: 11,
            lineSpacing: 1.4,
            margins: 20,
            sectionSpacing: 12,
            dividerStyle: 'line',
            layout: 'single',
            accentColor: '#000000',
            sectionOrder: ['summary', 'experience', 'education', 'skills', 'projects', 'certifications', 'languages'],
            customHTML: null,  // Store edited HTML from Direct Edit Mode
            sectionTitles: {
                summary: 'Professional Summary',
                experience: 'Work Experience',
                education: 'Education',
                skills: 'Skills',
                projects: 'Projects',
                certifications: 'Certifications',
                languages: 'Languages'
            }
        };

        let currentEditType = null;
        let currentEditIndex = null;
        let editModeEnabled = false;
        let isRendering = false;  // Flag to prevent observer from triggering during render
        let contentHasChanged = false;  // Flag to track if content has changed
        let db = null;
        const DB_NAME = 'ResumeBuilderDB';
        const DB_VERSION = 1;
        
        // Helper function to determine if we should preserve customHTML
        function shouldPreserveCustomHTML() {
            // Preserve customHTML if it exists and edit mode was enabled
            // This means the user has made direct edits that should be preserved
            return !!(designSettings.customHTML && editModeEnabled);
        }

        // ==================== INDEXEDDB DATABASE ====================
        function initDatabase() {
            return new Promise(function(resolve, reject) {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = function(event) {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = function(event) {
                    const database = event.target.result;
                    
                    // Create object store for saved resumes
                    if (!database.objectStoreNames.contains('resumes')) {
                        const resumeStore = database.createObjectStore('resumes', { keyPath: 'id', autoIncrement: true });
                        resumeStore.createIndex('name', 'name', { unique: false });
                        resumeStore.createIndex('date', 'date', { unique: false });
                    }
                    
                    // Create object store for current working state (auto-save)
                    if (!database.objectStoreNames.contains('currentState')) {
                        database.createObjectStore('currentState', { keyPath: 'id' });
                    }
                    
                    console.log('Database schema created/upgraded');
                };
            });
        }

        // Save current working state (auto-save)
        function autoSaveState() {
            if (!db) return;
            
            // Show saving indicator
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.innerHTML = '<i class="fas fa-sync fa-spin text-blue-500"></i><span>Saving...</span>';
            }
            
            const transaction = db.transaction(['currentState'], 'readwrite');
            const store = transaction.objectStore('currentState');
            
            const state = {
                id: 'current',
                resumeData: resumeData,
                designSettings: designSettings,
                lastModified: new Date().toISOString()
            };
            
            store.put(state);
            
            transaction.oncomplete = function() {
                console.log('Auto-saved current state');
                // Show saved indicator
                if (indicator) {
                    indicator.innerHTML = '<i class="fas fa-cloud text-green-500"></i><span>Saved</span>';
                }
            };
            
            transaction.onerror = function() {
                // Show error indicator
                if (indicator) {
                    indicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i><span>Error</span>';
                }
            };
        }

        // Load current working state on page load
        function loadCurrentState() {
            return new Promise(function(resolve, reject) {
                if (!db) {
                    resolve(false);
                    return;
                }
                
                const transaction = db.transaction(['currentState'], 'readonly');
                const store = transaction.objectStore('currentState');
                const request = store.get('current');
                
                request.onsuccess = function(event) {
                    const state = event.target.result;
                    if (state) {
                        resumeData = state.resumeData;
                        designSettings = state.designSettings;
                        // Initialize sectionTitles if it doesn't exist (for old saved data)
                        if (!designSettings.sectionTitles) {
                            designSettings.sectionTitles = {
                                summary: 'Professional Summary',
                                experience: 'Work Experience',
                                education: 'Education',
                                skills: 'Skills',
                                projects: 'Projects',
                                certifications: 'Certifications',
                                languages: 'Languages'
                            };
                        }
                        // Ensure customHTML is preserved if it exists
                        if (state.designSettings && state.designSettings.customHTML) {
                            console.log('Loaded customHTML from saved state (length:', state.designSettings.customHTML.length + ')');
                        }
                        populateFormFromData();
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                request.onerror = function() {
                    resolve(false);
                };
            });
        }

        // Save resume to database
        function saveResumeToDatabase(name) {
            return new Promise(function(resolve, reject) {
                if (!db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = db.transaction(['resumes'], 'readwrite');
                const store = transaction.objectStore('resumes');
                
                const resume = {
                    name: name,
                    date: new Date().toISOString(),
                    resumeData: JSON.parse(JSON.stringify(resumeData)),
                    designSettings: JSON.parse(JSON.stringify(designSettings))
                };
                
                const request = store.add(resume);
                
                request.onsuccess = function(event) {
                    console.log('Resume saved with ID:', event.target.result);
                    resolve(event.target.result);
                };
                
                request.onerror = function(event) {
                    console.error('Error saving resume:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Get all saved resumes from database
        function getAllResumesFromDatabase() {
            return new Promise(function(resolve, reject) {
                if (!db) {
                    resolve([]);
                    return;
                }
                
                const transaction = db.transaction(['resumes'], 'readonly');
                const store = transaction.objectStore('resumes');
                const request = store.getAll();
                
                request.onsuccess = function(event) {
                    const resumes = event.target.result || [];
                    // Sort by date descending (newest first)
                    resumes.sort(function(a, b) {
                        return new Date(b.date) - new Date(a.date);
                    });
                    resolve(resumes);
                };
                
                request.onerror = function(event) {
                    console.error('Error getting resumes:', event.target.error);
                    resolve([]);
                };
            });
        }

        // Load a specific resume from database
        function loadResumeFromDatabase(id) {
            return new Promise(function(resolve, reject) {
                if (!db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = db.transaction(['resumes'], 'readonly');
                const store = transaction.objectStore('resumes');
                const request = store.get(id);
                
                request.onsuccess = function(event) {
                    const resume = event.target.result;
                    if (resume) {
                        resolve(resume);
                    } else {
                        reject('Resume not found');
                    }
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        // Delete a resume from database
        function deleteResumeFromDatabase(id) {
            return new Promise(function(resolve, reject) {
                if (!db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = db.transaction(['resumes'], 'readwrite');
                const store = transaction.objectStore('resumes');
                const request = store.delete(id);
                
                request.onsuccess = function() {
                    console.log('Resume deleted:', id);
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        // Update an existing resume in database
        function updateResumeInDatabase(id, name) {
            return new Promise(function(resolve, reject) {
                if (!db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = db.transaction(['resumes'], 'readwrite');
                const store = transaction.objectStore('resumes');
                
                const resume = {
                    id: id,
                    name: name,
                    date: new Date().toISOString(),
                    resumeData: JSON.parse(JSON.stringify(resumeData)),
                    designSettings: JSON.parse(JSON.stringify(designSettings))
                };
                
                const request = store.put(resume);
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        // Populate form fields from loaded data
        function populateFormFromData() {
            // Personal info
            Object.keys(resumeData.personal).forEach(function(key) {
                const el = document.getElementById(key);
                if (el) el.value = resumeData.personal[key];
            });
            
            // Summary
            const summaryEl = document.getElementById('summary');
            if (summaryEl) {
                summaryEl.value = resumeData.summary;
                document.getElementById('summaryCount').textContent = resumeData.summary.length;
            }
            
            // Design settings
            document.getElementById('fontFamily').value = designSettings.fontFamily;
            document.getElementById('fontSize').value = designSettings.fontSize;
            document.getElementById('lineSpacing').value = designSettings.lineSpacing;
            document.getElementById('margins').value = designSettings.margins;
            document.getElementById('sectionSpacing').value = designSettings.sectionSpacing;
            
            // Divider style
            document.querySelectorAll('.divider-btn').forEach(function(btn) {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                if (btn.dataset.divider === designSettings.dividerStyle) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                }
            });
            
            // Layout
            document.querySelectorAll('.layout-btn').forEach(function(btn) {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                if (btn.dataset.layout === designSettings.layout) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                }
            });
            
            // Section titles
            if (designSettings.sectionTitles) {
                Object.keys(designSettings.sectionTitles).forEach(function(section) {
                    const el = document.getElementById('title-' + section);
                    if (el) el.value = designSettings.sectionTitles[section];
                });
            }
            
            // Render all lists and preview
            renderAllLists();
            // Don't force regenerate when loading - preserve customHTML if it exists
            renderResume(false);
            calculateAllScores();
            initializeSectionOrder();
            // Update design UI without clearing customHTML
            document.getElementById('fontSizeValue').textContent = designSettings.fontSize + 'px';
            document.getElementById('lineSpacingValue').textContent = designSettings.lineSpacing;
            document.getElementById('marginsValue').textContent = designSettings.margins + 'px';
            document.getElementById('sectionSpacingValue').textContent = designSettings.sectionSpacing + 'px';
        }

        // Debounce function for auto-save
        let autoSaveTimeout = null;
        function triggerAutoSave() {
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            autoSaveTimeout = setTimeout(function() {
                autoSaveState();
            }, 1000);
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize database
                await initDatabase();
                
                // Try to load previous state
                const hasState = await loadCurrentState();
                
                if (hasState) {
                    console.log('Loaded previous state from database');
                    showNotification('Your previous work has been restored!', 'success');
                }
            } catch (error) {
                console.error('Database initialization error:', error);
            }
            
            initializeSectionOrder();
            updatePreview();
            calculateAllScores();
            setupToolbarEvents();
            
            // Update page break indicator on window resize
            window.addEventListener('resize', function() {
                setTimeout(updatePageBreakIndicator, 200);
            });
        });

        // ==================== DIRECT EDIT MODE ====================
        function toggleEditMode(enabled) {
            editModeEnabled = enabled;
            const preview = document.getElementById('resumePreview');
            
            if (enabled) {
                preview.classList.add('resume-editable');
                makeContentEditable(preview);
            } else {
                // Save edited content before disabling edit mode
                // Clear the timeout and save immediately
                if (saveContentTimeout) {
                    clearTimeout(saveContentTimeout);
                    saveContentTimeout = null;
                }
                // Force immediate save
                isRendering = false; // Ensure we can save
                const contentDiv = preview.querySelector('div[style*="font-family"], div[style*="font-size"]');
                if (contentDiv) {
                    const clone = contentDiv.cloneNode(true);
                    clone.querySelectorAll('[contenteditable]').forEach(function(el) {
                        el.removeAttribute('contenteditable');
                    });
                    designSettings.customHTML = clone.outerHTML;
                    console.log('Saved custom HTML on edit mode disable (length:', designSettings.customHTML.length + ')');
                    triggerAutoSave();
                }
                preview.classList.remove('resume-editable');
                removeContentEditable(preview);
                hideToolbar();
            }
        }

        let contentObserver = null;
        
        function makeContentEditable(container) {
            const editableElements = container.querySelectorAll('h1, h2, h3, p, span, div');
            editableElements.forEach(function(el) {
                if (!el.querySelector('h1, h2, h3, p, span, div') || el.innerText.trim()) {
                    el.setAttribute('contenteditable', 'true');
                    // Remove existing listeners to avoid duplicates
                    el.removeEventListener('input', saveEditedContent);
                    el.removeEventListener('blur', saveEditedContent);
                    // Add event listeners to capture changes
                    el.addEventListener('input', saveEditedContent);
                    el.addEventListener('blur', saveEditedContent);
                }
            });
            
            // Set up MutationObserver to catch formatting changes (bold, italic, etc.)
            if (contentObserver) {
                contentObserver.disconnect();
            }
            contentObserver = new MutationObserver(function(mutations) {
                if (editModeEnabled && !isRendering) {
                    // Only save if mutations are from user interaction (not programmatic)
                    let shouldSave = false;
                    mutations.forEach(function(mutation) {
                        // Check if mutation is from user editing (not from our code)
                        if (mutation.type === 'characterData' || 
                            (mutation.type === 'childList' && mutation.addedNodes.length > 0) ||
                            (mutation.type === 'attributes' && mutation.target.hasAttribute('contenteditable'))) {
                            shouldSave = true;
                        }
                    });
                    if (shouldSave) {
                        saveEditedContent();
                    }
                }
            });
            contentObserver.observe(container, {
                childList: true,
                subtree: true,
                characterData: true,
                characterDataOldValue: true,
                attributes: true,
                attributeFilter: ['style', 'class']
            });
        }
        
        // Save edited content from Direct Edit Mode
        let saveContentTimeout = null;
        function saveEditedContent() {
            if (!editModeEnabled || isRendering) return;
            
            // Debounce saves to avoid too many saves
            if (saveContentTimeout) {
                clearTimeout(saveContentTimeout);
            }
            saveContentTimeout = setTimeout(function() {
                const preview = document.getElementById('resumePreview');
                if (preview) {
                    // Get the inner content div (the one with styles)
                    const contentDiv = preview.querySelector('div[style*="font-family"], div[style*="font-size"]');
                    if (contentDiv) {
                        // Clone the content div to save its HTML
                        const clone = contentDiv.cloneNode(true);
                        // Remove contenteditable attributes from the clone
                        clone.querySelectorAll('[contenteditable]').forEach(function(el) {
                            el.removeAttribute('contenteditable');
                        });
                        // Store the HTML of the inner content div (outerHTML includes the div tag)
                        designSettings.customHTML = clone.outerHTML;
                        console.log('Saved custom HTML (length:', designSettings.customHTML.length + ')');
                        triggerAutoSave();
                    } else {
                        // Fallback: save entire preview innerHTML
                        const clone = preview.cloneNode(true);
                        clone.querySelectorAll('[contenteditable]').forEach(function(el) {
                            el.removeAttribute('contenteditable');
                        });
                        designSettings.customHTML = clone.innerHTML;
                        console.log('Saved custom HTML (fallback, length:', designSettings.customHTML.length + ')');
                        triggerAutoSave();
                    }
                }
            }, 300);
        }

        function removeContentEditable(container) {
            const editableElements = container.querySelectorAll('[contenteditable]');
            editableElements.forEach(function(el) {
                el.removeAttribute('contenteditable');
            });
            // Disconnect observer when edit mode is disabled
            if (contentObserver) {
                contentObserver.disconnect();
                contentObserver = null;
            }
        }

        function setupToolbarEvents() {
            document.addEventListener('mouseup', function(e) {
                if (!editModeEnabled) return;
                
                const selection = window.getSelection();
                if (selection.toString().length > 0) {
                    showToolbar(e);
                } else {
                    hideToolbar();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (!editModeEnabled) return;
                
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'b') {
                        e.preventDefault();
                        formatText('bold');
                    } else if (e.key === 'i') {
                        e.preventDefault();
                        formatText('italic');
                    } else if (e.key === 'u') {
                        e.preventDefault();
                        formatText('underline');
                    }
                }
            });
        }

        function showToolbar(e) {
            const toolbar = document.getElementById('formatToolbar');
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                toolbar.style.left = (rect.left + rect.width / 2 - 100) + 'px';
                toolbar.style.top = (rect.top - 50 + window.scrollY) + 'px';
                toolbar.classList.add('visible');
                
                updateToolbarState();
            }
        }

        function hideToolbar() {
            document.getElementById('formatToolbar').classList.remove('visible');
        }

        function updateToolbarState() {
            document.getElementById('btn-bold').classList.toggle('active', document.queryCommandState('bold'));
            document.getElementById('btn-italic').classList.toggle('active', document.queryCommandState('italic'));
            document.getElementById('btn-underline').classList.toggle('active', document.queryCommandState('underline'));
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            updateToolbarState();
            // Save after formatting is applied
            setTimeout(saveEditedContent, 100);
        }

        function changeFontSize(size) {
            if (size) {
                document.execCommand('fontSize', false, size);
                // Save after font size change
                setTimeout(saveEditedContent, 100);
            }
            document.getElementById('fontSizeSelect').value = '';
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tab) {
            ['content', 'design', 'score'].forEach(function(t) {
                document.getElementById('tab-' + t).classList.remove('tab-active');
                document.getElementById('tab-' + t).classList.add('text-gray-500');
                document.getElementById('panel-' + t).classList.add('hidden');
            });
            document.getElementById('tab-' + tab).classList.add('tab-active');
            document.getElementById('tab-' + tab).classList.remove('text-gray-500');
            document.getElementById('panel-' + tab).classList.remove('hidden');
            
            if (tab === 'score') {
                calculateAllScores();
                renderScoreBreakdown();
            }
            if (tab === 'design') {
                initializeSectionOrder();
            }
        }

        // ==================== SECTION TOGGLE ====================
        function toggleSection(section) {
            const el = document.getElementById('section-' + section);
            const icon = document.getElementById('icon-' + section);
            el.classList.toggle('hidden');
            icon.style.transform = el.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        // ==================== NOTIFICATION SYSTEM ====================
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const text = document.getElementById('notificationText');
            
            text.textContent = message;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle text-green-400';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle text-red-400';
            } else if (type === 'info') {
                icon.className = 'fas fa-info-circle text-blue-400';
            } else {
                icon.className = 'fas fa-check-circle text-green-400';
            }
            
            notification.classList.remove('translate-y-full', 'opacity-0');
            
            setTimeout(function() {
                notification.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        }

        // ==================== PERSONAL INFO ====================
        function updatePreview() {
            resumeData.personal = {
                fullName: document.getElementById('fullName').value,
                jobTitle: document.getElementById('jobTitle').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                linkedin: document.getElementById('linkedin').value,
                website: document.getElementById('website').value,
                github: document.getElementById('github').value
            };
            resumeData.summary = document.getElementById('summary').value;

            // Mark that content has changed
            contentHasChanged = true;
            // Always regenerate from data so form field changes are reflected
            // If user has direct edits, they can re-apply them in edit mode
            // We clear customHTML here because the data has changed
            designSettings.customHTML = null;
            renderResume(true);
            calculateAllScores();
            triggerAutoSave();
        }

        // ==================== EXPERIENCE ====================
        function addExperience() {
            resumeData.experience.push({
                id: Date.now(),
                enabled: true,
                company: '',
                position: '',
                location: '',
                startDate: '',
                endDate: '',
                current: false,
                description: ''
            });
            renderExperienceList();
            openEditModal('experience', resumeData.experience.length - 1);
        }

        function renderExperienceList() {
            const container = document.getElementById('experienceList');
            container.innerHTML = resumeData.experience.map(function(exp, index) {
                const endDisplay = exp.current ? 'Present' : (exp.endDate || 'End');
                return '<div class="item-card border rounded-lg p-3 ' + (!exp.enabled ? 'item-disabled' : '') + '" data-index="' + index + '" data-type="experience" draggable="true">' +
                    '<div class="flex items-start justify-between">' +
                        '<div class="flex items-start gap-3">' +
                            '<div class="flex flex-col items-center gap-1 mt-1">' +
                                '<i class="fas fa-grip-vertical item-handle text-gray-400"></i>' +
                                '<input type="checkbox" ' + (exp.enabled ? 'checked' : '') + ' onchange="toggleItemEnabled(\'experience\', ' + index + ')" class="w-4 h-4 rounded border-gray-300">' +
                            '</div>' +
                            '<div>' +
                                '<h4 class="font-medium text-gray-800">' + (exp.position || 'Position Title') + '</h4>' +
                                '<p class="text-sm text-gray-500">' + (exp.company || 'Company Name') + (exp.location ? '  ' + exp.location : '') + '</p>' +
                                '<p class="text-xs text-gray-400">' + (exp.startDate || 'Start') + ' - ' + endDisplay + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-1">' +
                            '<button onclick="openEditModal(\'experience\', ' + index + ')" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="deleteItem(\'experience\', ' + index + ')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            initItemDragDrop(container, 'experience');
        }

        // ==================== EDUCATION ====================
        function addEducation() {
            resumeData.education.push({
                id: Date.now(),
                enabled: true,
                school: '',
                degree: '',
                field: '',
                location: '',
                startDate: '',
                endDate: '',
                current: false,
                gpa: '',
                achievements: ''
            });
            renderEducationList();
            openEditModal('education', resumeData.education.length - 1);
        }

        function renderEducationList() {
            const container = document.getElementById('educationList');
            container.innerHTML = resumeData.education.map(function(edu, index) {
                const endDisplay = edu.current ? 'Present' : (edu.endDate || 'End');
                return '<div class="item-card border rounded-lg p-3 ' + (!edu.enabled ? 'item-disabled' : '') + '" data-index="' + index + '" data-type="education" draggable="true">' +
                    '<div class="flex items-start justify-between">' +
                        '<div class="flex items-start gap-3">' +
                            '<div class="flex flex-col items-center gap-1 mt-1">' +
                                '<i class="fas fa-grip-vertical item-handle text-gray-400"></i>' +
                                '<input type="checkbox" ' + (edu.enabled ? 'checked' : '') + ' onchange="toggleItemEnabled(\'education\', ' + index + ')" class="w-4 h-4 rounded border-gray-300">' +
                            '</div>' +
                            '<div>' +
                                '<h4 class="font-medium text-gray-800">' + (edu.degree || 'Degree') + (edu.field ? ' in ' + edu.field : '') + '</h4>' +
                                '<p class="text-sm text-gray-500">' + (edu.school || 'School Name') + '</p>' +
                                '<p class="text-xs text-gray-400">' + (edu.startDate || 'Start') + ' - ' + endDisplay + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-1">' +
                            '<button onclick="openEditModal(\'education\', ' + index + ')" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="deleteItem(\'education\', ' + index + ')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            initItemDragDrop(container, 'education');
        }

        // ==================== SKILLS ====================
        function addSkillCategory() {
            resumeData.skills.push({
                id: Date.now(),
                enabled: true,
                category: '',
                skills: ''
            });
            renderSkillsList();
            openEditModal('skills', resumeData.skills.length - 1);
        }

        function renderSkillsList() {
            const container = document.getElementById('skillsList');
            container.innerHTML = resumeData.skills.map(function(skill, index) {
                return '<div class="item-card border rounded-lg p-3 ' + (!skill.enabled ? 'item-disabled' : '') + '" data-index="' + index + '" data-type="skills" draggable="true">' +
                    '<div class="flex items-start justify-between">' +
                        '<div class="flex items-start gap-3">' +
                            '<div class="flex flex-col items-center gap-1 mt-1">' +
                                '<i class="fas fa-grip-vertical item-handle text-gray-400"></i>' +
                                '<input type="checkbox" ' + (skill.enabled ? 'checked' : '') + ' onchange="toggleItemEnabled(\'skills\', ' + index + ')" class="w-4 h-4 rounded border-gray-300">' +
                            '</div>' +
                            '<div>' +
                                '<h4 class="font-medium text-gray-800">' + (skill.category || 'Category Name') + '</h4>' +
                                '<p class="text-sm text-gray-500 truncate max-w-xs">' + (skill.skills || 'Skills...') + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-1">' +
                            '<button onclick="openEditModal(\'skills\', ' + index + ')" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="deleteItem(\'skills\', ' + index + ')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            initItemDragDrop(container, 'skills');
        }

        // ==================== PROJECTS ====================
        function addProject() {
            resumeData.projects.push({
                id: Date.now(),
                enabled: true,
                name: '',
                organization: '',
                technologies: '',
                link: '',
                startDate: '',
                endDate: '',
                current: false,
                description: ''
            });
            renderProjectsList();
            openEditModal('projects', resumeData.projects.length - 1);
        }

        function renderProjectsList() {
            const container = document.getElementById('projectsList');
            container.innerHTML = resumeData.projects.map(function(proj, index) {
                const endDisplay = proj.current ? 'Present' : (proj.endDate || 'End');
                return '<div class="item-card border rounded-lg p-3 ' + (!proj.enabled ? 'item-disabled' : '') + '" data-index="' + index + '" data-type="projects" draggable="true">' +
                    '<div class="flex items-start justify-between">' +
                        '<div class="flex items-start gap-3">' +
                            '<div class="flex flex-col items-center gap-1 mt-1">' +
                                '<i class="fas fa-grip-vertical item-handle text-gray-400"></i>' +
                                '<input type="checkbox" ' + (proj.enabled ? 'checked' : '') + ' onchange="toggleItemEnabled(\'projects\', ' + index + ')" class="w-4 h-4 rounded border-gray-300">' +
                            '</div>' +
                            '<div>' +
                                '<h4 class="font-medium text-gray-800">' + (proj.name || 'Project Name') + '</h4>' +
                                '<p class="text-sm text-gray-500">' + (proj.organization || proj.technologies || 'Technologies') + '</p>' +
                                '<p class="text-xs text-gray-400">' + (proj.startDate || 'Start') + ' - ' + endDisplay + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-1">' +
                            '<button onclick="openEditModal(\'projects\', ' + index + ')" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="deleteItem(\'projects\', ' + index + ')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            initItemDragDrop(container, 'projects');
        }

        // ==================== CERTIFICATIONS ====================
        function addCertification() {
            resumeData.certifications.push({
                id: Date.now(),
                enabled: true,
                name: '',
                issuer: '',
                date: '',
                expiry: '',
                current: false,
                credentialId: '',
                link: '',
                description: ''
            });
            renderCertificationsList();
            openEditModal('certifications', resumeData.certifications.length - 1);
        }

        function renderCertificationsList() {
            const container = document.getElementById('certificationsList');
            container.innerHTML = resumeData.certifications.map(function(cert, index) {
                return '<div class="item-card border rounded-lg p-3 ' + (!cert.enabled ? 'item-disabled' : '') + '" data-index="' + index + '" data-type="certifications" draggable="true">' +
                    '<div class="flex items-start justify-between">' +
                        '<div class="flex items-start gap-3">' +
                            '<div class="flex flex-col items-center gap-1 mt-1">' +
                                '<i class="fas fa-grip-vertical item-handle text-gray-400"></i>' +
                                '<input type="checkbox" ' + (cert.enabled ? 'checked' : '') + ' onchange="toggleItemEnabled(\'certifications\', ' + index + ')" class="w-4 h-4 rounded border-gray-300">' +
                            '</div>' +
                            '<div>' +
                                '<h4 class="font-medium text-gray-800">' + (cert.name || 'Certification Name') + '</h4>' +
                                '<p class="text-sm text-gray-500">' + (cert.issuer || 'Issuing Organization') + '</p>' +
                                '<p class="text-xs text-gray-400">' + (cert.date || 'Date') + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-1">' +
                            '<button onclick="openEditModal(\'certifications\', ' + index + ')" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="deleteItem(\'certifications\', ' + index + ')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            initItemDragDrop(container, 'certifications');
        }

        // ==================== LANGUAGES ====================
        function addLanguage() {
            resumeData.languages.push({
                id: Date.now(),
                enabled: true,
                language: '',
                proficiency: 'Professional'
            });
            renderLanguagesList();
            openEditModal('languages', resumeData.languages.length - 1);
        }

        function renderLanguagesList() {
            const container = document.getElementById('languagesList');
            container.innerHTML = resumeData.languages.map(function(lang, index) {
                return '<div class="item-card border rounded-lg p-3 ' + (!lang.enabled ? 'item-disabled' : '') + '" data-index="' + index + '" data-type="languages" draggable="true">' +
                    '<div class="flex items-start justify-between">' +
                        '<div class="flex items-start gap-3">' +
                            '<div class="flex flex-col items-center gap-1 mt-1">' +
                                '<i class="fas fa-grip-vertical item-handle text-gray-400"></i>' +
                                '<input type="checkbox" ' + (lang.enabled ? 'checked' : '') + ' onchange="toggleItemEnabled(\'languages\', ' + index + ')" class="w-4 h-4 rounded border-gray-300">' +
                            '</div>' +
                            '<div>' +
                                '<h4 class="font-medium text-gray-800">' + (lang.language || 'Language') + '</h4>' +
                                '<p class="text-sm text-gray-500">' + (lang.proficiency || 'Proficiency') + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-1">' +
                            '<button onclick="openEditModal(\'languages\', ' + index + ')" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="deleteItem(\'languages\', ' + index + ')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            initItemDragDrop(container, 'languages');
        }

        // ==================== ITEM MANAGEMENT ====================
        function toggleItemEnabled(type, index) {
            resumeData[type][index].enabled = !resumeData[type][index].enabled;
            // Mark that content has changed
            contentHasChanged = true;
            // Structural change: enabling/disabling items affects what's displayed in HTML
            designSettings.customHTML = null;
            renderAllLists();
            renderResume(true);
            triggerAutoSave();
        }

        function deleteItem(type, index) {
            if (confirm('Are you sure you want to delete this item?')) {
                resumeData[type].splice(index, 1);
                // Mark that content has changed
                contentHasChanged = true;
                // Structural change: deleting items affects HTML structure
                designSettings.customHTML = null;
                renderAllLists();
                renderResume(true);
                calculateAllScores();
                triggerAutoSave();
            }
        }

        function renderAllLists() {
            renderExperienceList();
            renderEducationList();
            renderSkillsList();
            renderProjectsList();
            renderCertificationsList();
            renderLanguagesList();
        }

        // ==================== MODAL HANDLING ====================
        function openEditModal(type, index) {
            currentEditType = type;
            currentEditIndex = index;
            const modal = document.getElementById('editModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');

            const titles = {
                experience: 'Edit Work Experience',
                education: 'Edit Education',
                skills: 'Edit Skills Category',
                projects: 'Edit Project',
                certifications: 'Edit Certification',
                languages: 'Edit Language'
            };
            title.textContent = titles[type];

            const item = resumeData[type][index];
            
            if (type === 'experience') {
                content.innerHTML = '<div class="space-y-4">' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Position/Job Title *</label>' +
                            '<input type="text" id="edit-position" value="' + escapeHtml(item.position || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Software Engineer">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Company *</label>' +
                            '<input type="text" id="edit-company" value="' + escapeHtml(item.company || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Google">' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Location</label>' +
                            '<input type="text" id="edit-location" value="' + escapeHtml(item.location || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="San Francisco, CA">' +
                        '</div>' +
                        '<div class="flex items-end">' +
                            '<label class="flex items-center gap-2 pb-2">' +
                                '<input type="checkbox" id="edit-current" ' + (item.current ? 'checked' : '') + ' onchange="toggleCurrentStatus(\'experience\')" class="w-4 h-4 rounded">' +
                                '<span class="text-sm text-gray-700">I currently work here</span>' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>' +
                            '<input type="month" id="edit-startDate" value="' + (item.startDate || '') + '" class="w-full px-3 py-2 border rounded-lg">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>' +
                            '<input type="month" id="edit-endDate" value="' + (item.endDate || '') + '" class="w-full px-3 py-2 border rounded-lg" ' + (item.current ? 'disabled' : '') + '>' +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Description</label>' +
                        createRichTextEditor('edit-description', item.description || '', 'Led development of new features that increased user engagement by 25%') +
                    '</div>' +
                '</div>';
            } else if (type === 'education') {
                content.innerHTML = '<div class="space-y-4">' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">School/University *</label>' +
                            '<input type="text" id="edit-school" value="' + escapeHtml(item.school || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Stanford University">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Location</label>' +
                            '<input type="text" id="edit-location" value="' + escapeHtml(item.location || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Stanford, CA">' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Degree *</label>' +
                            '<select id="edit-degree" class="w-full px-3 py-2 border rounded-lg">' +
                                '<option value="">Select Degree</option>' +
                                '<option value="High School Diploma"' + (item.degree === 'High School Diploma' ? ' selected' : '') + '>High School Diploma</option>' +
                                '<option value="Associate\'s"' + (item.degree === "Associate's" ? ' selected' : '') + '>Associate\'s Degree</option>' +
                                '<option value="Bachelor\'s"' + (item.degree === "Bachelor's" ? ' selected' : '') + '>Bachelor\'s Degree</option>' +
                                '<option value="Master\'s"' + (item.degree === "Master's" ? ' selected' : '') + '>Master\'s Degree</option>' +
                                '<option value="Ph.D."' + (item.degree === 'Ph.D.' ? ' selected' : '') + '>Ph.D.</option>' +
                                '<option value="MBA"' + (item.degree === 'MBA' ? ' selected' : '') + '>MBA</option>' +
                                '<option value="Other"' + (item.degree === 'Other' ? ' selected' : '') + '>Other</option>' +
                            '</select>' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Field of Study</label>' +
                            '<input type="text" id="edit-field" value="' + escapeHtml(item.field || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Computer Science">' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>' +
                            '<input type="month" id="edit-startDate" value="' + (item.startDate || '') + '" class="w-full px-3 py-2 border rounded-lg">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>' +
                            '<input type="month" id="edit-endDate" value="' + (item.endDate || '') + '" class="w-full px-3 py-2 border rounded-lg" ' + (item.current ? 'disabled' : '') + '>' +
                            '<label class="flex items-center gap-2 mt-2">' +
                                '<input type="checkbox" id="edit-current" ' + (item.current ? 'checked' : '') + ' onchange="toggleCurrentStatus(\'education\')" class="w-4 h-4 rounded">' +
                                '<span class="text-sm text-gray-700">Currently enrolled</span>' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">GPA (Optional)</label>' +
                        '<input type="text" id="edit-gpa" value="' + escapeHtml(item.gpa || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="3.8/4.0">' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Achievements/Activities</label>' +
                        createRichTextEditor('edit-achievements', item.achievements || '', 'Dean\'s List') +
                    '</div>' +
                '</div>';
            } else if (type === 'skills') {
                content.innerHTML = '<div class="space-y-4">' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>' +
                        '<input type="text" id="edit-category" value="' + escapeHtml(item.category || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Programming Languages">' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Skills (comma separated)</label>' +
                        '<textarea id="edit-skills" rows="3" class="w-full px-3 py-2 border rounded-lg" placeholder="JavaScript, Python, Java, C++">' + escapeHtml(item.skills || '') + '</textarea>' +
                    '</div>' +
                '</div>';
            } else if (type === 'projects') {
                content.innerHTML = '<div class="space-y-4">' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Project Name *</label>' +
                            '<input type="text" id="edit-name" value="' + escapeHtml(item.name || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="E-commerce Platform">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Organization</label>' +
                            '<input type="text" id="edit-organization" value="' + escapeHtml(item.organization || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Company or School Name">' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Technologies Used</label>' +
                            '<input type="text" id="edit-technologies" value="' + escapeHtml(item.technologies || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="React, Node.js, MongoDB">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Link (Optional)</label>' +
                            '<input type="text" id="edit-link" value="' + escapeHtml(item.link || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="github.com/project">' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>' +
                            '<input type="month" id="edit-startDate" value="' + (item.startDate || '') + '" class="w-full px-3 py-2 border rounded-lg">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>' +
                            '<input type="month" id="edit-endDate" value="' + (item.endDate || '') + '" class="w-full px-3 py-2 border rounded-lg" ' + (item.current ? 'disabled' : '') + '>' +
                            '<label class="flex items-center gap-2 mt-2">' +
                                '<input type="checkbox" id="edit-current" ' + (item.current ? 'checked' : '') + ' onchange="toggleCurrentStatus(\'projects\')" class="w-4 h-4 rounded">' +
                                '<span class="text-sm text-gray-700">Ongoing project</span>' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Description</label>' +
                        createRichTextEditor('edit-description', item.description || '', 'Built a full-stack e-commerce platform with user authentication') +
                    '</div>' +
                '</div>';
            } else if (type === 'certifications') {
                content.innerHTML = '<div class="space-y-4">' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Certification Name *</label>' +
                            '<input type="text" id="edit-name" value="' + escapeHtml(item.name || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="AWS Solutions Architect">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Issuing Organization *</label>' +
                            '<input type="text" id="edit-issuer" value="' + escapeHtml(item.issuer || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Amazon Web Services">' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Issue Date</label>' +
                            '<input type="month" id="edit-date" value="' + (item.date || '') + '" class="w-full px-3 py-2 border rounded-lg">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>' +
                            '<input type="month" id="edit-expiry" value="' + (item.expiry || '') + '" class="w-full px-3 py-2 border rounded-lg" ' + (item.current ? 'disabled' : '') + '>' +
                            '<label class="flex items-center gap-2 mt-2">' +
                                '<input type="checkbox" id="edit-current" ' + (item.current ? 'checked' : '') + ' onchange="toggleCurrentStatus(\'certifications\')" class="w-4 h-4 rounded">' +
                                '<span class="text-sm text-gray-700">No expiration / Lifetime</span>' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Credential ID</label>' +
                            '<input type="text" id="edit-credentialId" value="' + escapeHtml(item.credentialId || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="ABC123XYZ">' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-gray-700 mb-1">Credential URL</label>' +
                            '<input type="text" id="edit-link" value="' + escapeHtml(item.link || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="https://verify.cert.com/abc123">' +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>' +
                        createRichTextEditor('edit-description', item.description || '', 'Key skills or knowledge gained from this certification') +
                    '</div>' +
                '</div>';
            } else if (type === 'languages') {
                content.innerHTML = '<div class="space-y-4">' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Language</label>' +
                        '<input type="text" id="edit-language" value="' + escapeHtml(item.language || '') + '" class="w-full px-3 py-2 border rounded-lg" placeholder="Spanish">' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-gray-700 mb-1">Proficiency Level</label>' +
                        '<select id="edit-proficiency" class="w-full px-3 py-2 border rounded-lg">' +
                            '<option value="Native"' + (item.proficiency === 'Native' ? ' selected' : '') + '>Native</option>' +
                            '<option value="Fluent"' + (item.proficiency === 'Fluent' ? ' selected' : '') + '>Fluent</option>' +
                            '<option value="Professional"' + (item.proficiency === 'Professional' ? ' selected' : '') + '>Professional</option>' +
                            '<option value="Intermediate"' + (item.proficiency === 'Intermediate' ? ' selected' : '') + '>Intermediate</option>' +
                            '<option value="Basic"' + (item.proficiency === 'Basic' ? ' selected' : '') + '>Basic</option>' +
                        '</select>' +
                    '</div>' +
                '</div>';
            }

            modal.classList.remove('hidden');
            
            // Add keyboard shortcuts for rich text editors in modal
            const richTextEditors = content.querySelectorAll('.rich-text-editor');
            richTextEditors.forEach(function(editor) {
                editor.addEventListener('keydown', function(e) {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'b') {
                            e.preventDefault();
                            formatModalText(editor.id, 'bold');
                        } else if (e.key === 'i') {
                            e.preventDefault();
                            formatModalText(editor.id, 'italic');
                        } else if (e.key === 'u') {
                            e.preventDefault();
                            formatModalText(editor.id, 'underline');
                        }
                    }
                });
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function to create rich text editor HTML (each new line = one paragraph; preview shows each line as a bullet)
        function createRichTextEditor(id, value, placeholder) {
            let htmlValue = '';
            if (value) {
                var plain = value;
                if (value.includes('<') && value.includes('>')) {
                    var div = document.createElement('div');
                    div.innerHTML = value;
                    plain = div.innerText || '';
                }
                htmlValue = plain.split('\n').map(function(line) {
                    return line.trim() ? '<p>' + escapeHtml(line) + '</p>' : '<p><br></p>';
                }).join('');
            }
            
            return '<div class="rich-text-toolbar" id="' + id + '-toolbar">' +
                '<button type="button" onclick="formatModalText(\'' + id + '\', \'bold\')" title="Bold (Ctrl+B)">' +
                    '<i class="fas fa-bold"></i>' +
                '</button>' +
                '<button type="button" onclick="formatModalText(\'' + id + '\', \'italic\')" title="Italic (Ctrl+I)">' +
                    '<i class="fas fa-italic"></i>' +
                '</button>' +
                '<button type="button" onclick="formatModalText(\'' + id + '\', \'underline\')" title="Underline (Ctrl+U)">' +
                    '<i class="fas fa-underline"></i>' +
                '</button>' +
                '<div class="separator"></div>' +
                '<button type="button" onclick="formatModalText(\'' + id + '\', \'removeFormat\')" title="Clear Formatting">' +
                    '<i class="fas fa-eraser"></i>' +
                '</button>' +
            '</div>' +
            '<div id="' + id + '" class="rich-text-editor" contenteditable="true" data-placeholder="' + (placeholder || '') + '">' + htmlValue + '</div>' +
            '<p class="text-xs text-gray-400 mt-1">You can format text (bold, italic). Each new line will appear as a bullet point on the resume.</p>';
        }
        
        // Format text in modal editors
        function formatModalText(editorId, command) {
            const editor = document.getElementById(editorId);
            if (!editor) return;
            
            editor.focus();
            document.execCommand(command, false, null);
            
            // Update toolbar button states
            const toolbar = document.getElementById(editorId + '-toolbar');
            if (toolbar) {
                toolbar.querySelectorAll('button').forEach(function(btn) {
                    btn.classList.remove('active');
                });
                // Check which commands are active
                if (command === 'bold' && document.queryCommandState('bold')) {
                    toolbar.querySelector('button[onclick*="bold"]').classList.add('active');
                }
                if (command === 'italic' && document.queryCommandState('italic')) {
                    toolbar.querySelector('button[onclick*="italic"]').classList.add('active');
                }
                if (command === 'underline' && document.queryCommandState('underline')) {
                    toolbar.querySelector('button[onclick*="underline"]').classList.add('active');
                }
            }
        }
        
        // Get plain text from rich text editor (one line per block; newlines = bullet items on preview)
        function getRichTextContent(editorId) {
            const editor = document.getElementById(editorId);
            if (!editor) return '';
            return editor.innerText || '';
        }
        
        // Set content in rich text editor (plain text; each newline becomes a paragraph/line)
        function setRichTextContent(editorId, content) {
            const editor = document.getElementById(editorId);
            if (!editor) return;
            if (content) {
                // If content has HTML (e.g. old saved data), convert to plain text with newlines
                var plain = content;
                if (content.includes('<') && content.includes('>')) {
                    var div = document.createElement('div');
                    div.innerHTML = content;
                    plain = div.innerText || '';
                }
                editor.innerHTML = plain.split('\n').map(function(line) {
                    return line.trim() ? '<p>' + escapeHtml(line) + '</p>' : '<p><br></p>';
                }).join('');
            } else {
                editor.innerHTML = '';
            }
        }

        function toggleCurrentStatus(type) {
            const endDateInput = document.getElementById('edit-endDate');
            const expiryInput = document.getElementById('edit-expiry');
            const currentCheckbox = document.getElementById('edit-current');
            
            if (endDateInput) {
                endDateInput.disabled = currentCheckbox.checked;
                if (currentCheckbox.checked) endDateInput.value = '';
            }
            if (expiryInput) {
                expiryInput.disabled = currentCheckbox.checked;
                if (currentCheckbox.checked) expiryInput.value = '';
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditType = null;
            currentEditIndex = null;
        }

        function saveModalData() {
            const type = currentEditType;
            const index = currentEditIndex;
            const item = resumeData[type][index];

            if (type === 'experience') {
                item.position = document.getElementById('edit-position').value;
                item.company = document.getElementById('edit-company').value;
                item.location = document.getElementById('edit-location').value;
                item.startDate = document.getElementById('edit-startDate').value;
                item.endDate = document.getElementById('edit-endDate').value;
                item.current = document.getElementById('edit-current').checked;
                item.description = getRichTextContent('edit-description');
            } else if (type === 'education') {
                item.school = document.getElementById('edit-school').value;
                item.degree = document.getElementById('edit-degree').value;
                item.field = document.getElementById('edit-field').value;
                item.location = document.getElementById('edit-location').value;
                item.startDate = document.getElementById('edit-startDate').value;
                item.endDate = document.getElementById('edit-endDate').value;
                item.current = document.getElementById('edit-current').checked;
                item.gpa = document.getElementById('edit-gpa').value;
                item.achievements = getRichTextContent('edit-achievements');
            } else if (type === 'skills') {
                item.category = document.getElementById('edit-category').value;
                item.skills = document.getElementById('edit-skills').value;
            } else if (type === 'projects') {
                item.name = document.getElementById('edit-name').value;
                item.organization = document.getElementById('edit-organization').value;
                item.link = document.getElementById('edit-link').value;
                item.technologies = document.getElementById('edit-technologies').value;
                item.startDate = document.getElementById('edit-startDate').value;
                item.endDate = document.getElementById('edit-endDate').value;
                item.current = document.getElementById('edit-current').checked;
                item.description = getRichTextContent('edit-description');
            } else if (type === 'certifications') {
                item.name = document.getElementById('edit-name').value;
                item.issuer = document.getElementById('edit-issuer').value;
                item.date = document.getElementById('edit-date').value;
                item.expiry = document.getElementById('edit-expiry').value;
                item.current = document.getElementById('edit-current').checked;
                item.credentialId = document.getElementById('edit-credentialId').value;
                item.link = document.getElementById('edit-link').value;
                item.description = getRichTextContent('edit-description');
            } else if (type === 'languages') {
                item.language = document.getElementById('edit-language').value;
                item.proficiency = document.getElementById('edit-proficiency').value;
            }

            closeModal();
            // Mark that content has changed
            contentHasChanged = true;
            // Always regenerate from data so item changes are reflected
            // If user has direct edits, they can re-apply them in edit mode
            designSettings.customHTML = null;
            renderAllLists();
            renderResume(true);
            calculateAllScores();
            triggerAutoSave();
        }

        // ==================== DESIGN SETTINGS ====================
        function updateDesign() {
            designSettings.fontFamily = document.getElementById('fontFamily').value;
            designSettings.fontSize = parseInt(document.getElementById('fontSize').value);
            designSettings.lineSpacing = parseFloat(document.getElementById('lineSpacing').value);
            designSettings.margins = parseInt(document.getElementById('margins').value);
            designSettings.sectionSpacing = parseInt(document.getElementById('sectionSpacing').value);

            document.getElementById('fontSizeValue').textContent = designSettings.fontSize + 'px';
            document.getElementById('lineSpacingValue').textContent = designSettings.lineSpacing;
            document.getElementById('marginsValue').textContent = designSettings.margins + 'px';
            document.getElementById('sectionSpacingValue').textContent = designSettings.sectionSpacing + 'px';

            // Apply design settings to customHTML if it exists and content hasn't changed (preserves direct edits)
            // Otherwise regenerate from data
            if (designSettings.customHTML && !contentHasChanged) {
                // Don't clear customHTML - apply settings to it instead
                renderResume(false); // This will apply design settings to customHTML
            } else {
                // Content has changed or no customHTML, regenerate normally
                contentHasChanged = false; // Reset flag
                designSettings.customHTML = null; // Clear customHTML if content changed
                renderResume(true);
            }
            triggerAutoSave();
        }

        function setDivider(style) {
            designSettings.dividerStyle = style;
            document.querySelectorAll('.divider-btn').forEach(function(btn) {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                if (btn.dataset.divider === style) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                }
            });
            // Structural change: divider style affects HTML classes
            designSettings.customHTML = null;
            renderResume(true);
            triggerAutoSave();
        }

        function setLayout(layout) {
            designSettings.layout = layout;
            document.querySelectorAll('.layout-btn').forEach(function(btn) {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                if (btn.dataset.layout === layout) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                }
            });
            // Structural change: layout affects spacing and HTML structure
            designSettings.customHTML = null;
            renderResume(true);
            triggerAutoSave();
        }

        function setAccentColor(color) {
            designSettings.accentColor = color;
            // Structural change: accent color affects heading styles in HTML
            designSettings.customHTML = null;
            renderResume(true);
            triggerAutoSave();
        }
        
        function updateSectionTitle(section, title) {
            designSettings.sectionTitles[section] = title || designSettings.sectionTitles[section];
            // Structural change: section titles affect HTML
            designSettings.customHTML = null;
            renderResume(true);
            triggerAutoSave();
        }

        // ==================== SECTION ORDER ====================
        function initializeSectionOrder() {
            const container = document.getElementById('sectionOrder');
            const sectionNames = {
                summary: 'Professional Summary',
                experience: 'Work Experience',
                education: 'Education',
                skills: 'Skills',
                projects: 'Projects',
                certifications: 'Certifications',
                languages: 'Languages'
            };

            container.innerHTML = designSettings.sectionOrder.map(function(section) {
                return '<div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-move border" draggable="true" data-section="' + section + '">' +
                    '<i class="fas fa-grip-vertical text-gray-400 section-handle"></i>' +
                    '<span class="flex-1">' + sectionNames[section] + '</span>' +
                    '<label class="flex items-center">' +
                        '<input type="checkbox" checked class="w-4 h-4 rounded" onchange="toggleSectionVisibility(\'' + section + '\', this.checked)">' +
                    '</label>' +
                '</div>';
            }).join('');

            const items = container.querySelectorAll('[draggable]');
            items.forEach(function(item) {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
            });
        }

        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(function(el) { el.classList.remove('drag-over'); });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (this !== draggedItem) {
                const container = document.getElementById('sectionOrder');
                const items = Array.from(container.children);
                const draggedIndex = items.indexOf(draggedItem);
                const targetIndex = items.indexOf(this);

                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }

                designSettings.sectionOrder = Array.from(container.children).map(function(el) { return el.dataset.section; });
                // Structural change: section order affects HTML structure
                designSettings.customHTML = null;
                renderResume(true);
                triggerAutoSave();
            }
        }

        function toggleSectionVisibility(section, visible) {
            renderResume();
            triggerAutoSave();
        }

        // Helper function to reorder items in customHTML while preserving edits
        // Note: This is called AFTER data is reordered, so we need to regenerate and preserve formatting
        function reorderItemsInCustomHTML(type) {
            if (!designSettings.customHTML) return false;
            
            try {
                // Regenerate resume from reordered data
                // This ensures the order matches the data
                isRendering = true;
                const preview = document.getElementById('resumePreview');
                const p = resumeData.personal;
                const dividerClass = 'divider-' + designSettings.dividerStyle;
                
                const lineHeight = designSettings.layout === 'compact' ? designSettings.lineSpacing * 0.9 : designSettings.lineSpacing;
                const sectionMargin = designSettings.layout === 'compact' ? designSettings.sectionSpacing * 0.7 : designSettings.sectionSpacing;

                let html = '<div style="font-family: ' + designSettings.fontFamily + '; font-size: ' + designSettings.fontSize + 'px; line-height: ' + lineHeight + '; padding: ' + designSettings.margins + 'px;">';

                // Header
                if (p.fullName || p.email || p.phone) {
                    html += '<div style="text-align: center; margin-bottom: 12px;">';
                    html += '<h1 style="font-size: ' + (designSettings.fontSize * 2.1) + 'px; font-weight: bold; color: ' + designSettings.accentColor + '; margin-bottom: 4px;">' + (p.fullName || 'Your Name') + '</h1>';
                    if (p.jobTitle) {
                        html += '<p style="font-size: ' + (designSettings.fontSize * 1.1) + 'px; color: #4b5563; margin-bottom: 6px;">' + p.jobTitle + '</p>';
                    }
                    
                    let contactItems = [];
                    if (p.email) contactItems.push('<span class="contact-icon"><i class="fas fa-envelope"></i> ' + p.email + '</span>');
                    if (p.phone) contactItems.push('<span class="contact-icon"><i class="fas fa-phone"></i> ' + p.phone + '</span>');
                    if (p.location) contactItems.push('<span class="contact-icon"><i class="fas fa-map-marker-alt"></i> ' + p.location + '</span>');
                    
                    if (contactItems.length > 0) {
                        html += '<div style="font-size: ' + (designSettings.fontSize * 0.95) + 'px; color: #6b7280; display: flex; justify-content: center; flex-wrap: wrap; gap: 12px;">' + contactItems.join('') + '</div>';
                    }
                    
                    let linkItems = [];
                    if (p.linkedin) linkItems.push('<span class="contact-icon"><i class="fab fa-linkedin"></i> ' + p.linkedin + '</span>');
                    if (p.website) linkItems.push('<span class="contact-icon"><i class="fas fa-globe"></i> ' + p.website + '</span>');
                    if (p.github) linkItems.push('<span class="contact-icon"><i class="fab fa-github"></i> ' + p.github + '</span>');
                    
                    if (linkItems.length > 0) {
                        html += '<div style="font-size: ' + (designSettings.fontSize * 0.95) + 'px; color: #6b7280; display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; margin-top: 4px;">' + linkItems.join('') + '</div>';
                    }
                    
                    html += '</div>';
                }

                designSettings.sectionOrder.forEach(function(section) {
                    const sectionHtml = renderSection(section, dividerClass, sectionMargin);
                    if (sectionHtml) html += sectionHtml;
                });

                html += '</div>';
                preview.innerHTML = html;
                
                // Now try to preserve formatting from old customHTML by copying styles
                // This is a simplified approach - we regenerate with correct order, 
                // and the user can re-apply formatting if needed
                // For now, we'll save the regenerated HTML as the new customHTML
                const contentDiv = preview.querySelector('div[style*="font-family"], div[style*="font-size"]');
                if (contentDiv) {
                    const clone = contentDiv.cloneNode(true);
                    clone.querySelectorAll('[contenteditable]').forEach(function(el) {
                        el.removeAttribute('contenteditable');
                    });
                    designSettings.customHTML = clone.outerHTML;
                    isRendering = false;
                    return true;
                }
                isRendering = false;
            } catch (e) {
                console.error('Error reordering items in customHTML:', e);
                isRendering = false;
            }
            return false;
        }

        // ==================== ITEM DRAG & DROP ====================
        let draggedItemElement = null;
        let draggedItemType = null;

        function initItemDragDrop(container, type) {
            const items = container.querySelectorAll('[draggable="true"]');
            items.forEach(function(item) {
                item.addEventListener('dragstart', handleItemDragStart);
                item.addEventListener('dragend', handleItemDragEnd);
                item.addEventListener('dragover', handleItemDragOver);
                item.addEventListener('dragleave', handleItemDragLeave);
                item.addEventListener('drop', handleItemDrop);
            });
        }

        function handleItemDragStart(e) {
            draggedItemElement = this;
            draggedItemType = this.dataset.type;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        function handleItemDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(function(el) { 
                el.classList.remove('drag-over'); 
            });
            draggedItemElement = null;
            draggedItemType = null;
        }

        function handleItemDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Only allow drop on same type items
            if (this !== draggedItemElement && this.dataset.type === draggedItemType) {
                this.classList.add('drag-over');
            }
        }

        function handleItemDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleItemDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (this === draggedItemElement) return;
            if (this.dataset.type !== draggedItemType) return;
            
            const type = this.dataset.type;
            const fromIndex = parseInt(draggedItemElement.dataset.index);
            const toIndex = parseInt(this.dataset.index);
            
            // Reorder the array
            const items = resumeData[type];
            const movedItem = items.splice(fromIndex, 1)[0];
            items.splice(toIndex, 0, movedItem);
            
            // Re-render the list
            switch(type) {
                case 'experience':
                    renderExperienceList();
                    break;
                case 'education':
                    renderEducationList();
                    break;
                case 'skills':
                    renderSkillsList();
                    break;
                case 'projects':
                    renderProjectsList();
                    break;
                case 'certifications':
                    renderCertificationsList();
                    break;
                case 'languages':
                    renderLanguagesList();
                    break;
            }
            
            // Try to preserve customHTML by regenerating with correct order
            // This regenerates the HTML with the new order and saves it as customHTML
            // so the user can continue editing
            const preserved = reorderItemsInCustomHTML(type);
            if (preserved) {
                // Regenerated with new order, saved as customHTML
                if (editModeEnabled) {
                    makeContentEditable(document.getElementById('resumePreview'));
                }
                setTimeout(updatePageBreakIndicator, 100);
                showNotification('Item order updated! Resume regenerated with new order.', 'success');
            } else {
                // Fallback: regenerate normally
                designSettings.customHTML = null;
                renderResume(true);
                showNotification('Item order updated!', 'success');
            }
            triggerAutoSave();
        }

        // ==================== RESUME RENDERING ====================
        function renderResume(forceRegenerate) {
            isRendering = true;  // Prevent observer from triggering during render
            const preview = document.getElementById('resumePreview');
            const p = resumeData.personal;
            const dividerClass = 'divider-' + designSettings.dividerStyle;
            
            const lineHeight = designSettings.layout === 'compact' ? designSettings.lineSpacing * 0.9 : designSettings.lineSpacing;
            const sectionMargin = designSettings.layout === 'compact' ? designSettings.sectionSpacing * 0.7 : designSettings.sectionSpacing;

            // Check if we should use saved custom HTML (if it exists and not forcing regenerate and content hasn't changed)
            if (designSettings.customHTML && !forceRegenerate && !contentHasChanged) {
                console.log('Using saved custom HTML (length:', designSettings.customHTML.length + ')');
                // Apply the customHTML but update design settings (font size, spacing, margins, etc.)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = designSettings.customHTML;
                
                // Find the main content div (the one with font-family or font-size style)
                let contentDiv = tempDiv.querySelector('div[style*="font-family"]');
                if (!contentDiv) {
                    contentDiv = tempDiv.querySelector('div[style*="font-size"]');
                }
                if (!contentDiv && tempDiv.firstElementChild) {
                    contentDiv = tempDiv.firstElementChild;
                }
                
                if (contentDiv) {
                    // Update the main content div styles to match current design settings
                    contentDiv.style.fontFamily = designSettings.fontFamily;
                    contentDiv.style.fontSize = designSettings.fontSize + 'px';
                    contentDiv.style.lineHeight = lineHeight;
                    contentDiv.style.padding = designSettings.margins + 'px';
                    
                    // Update all heading styles to match current accent color and font sizes
                    const h1 = contentDiv.querySelector('h1');
                    if (h1) {
                        h1.style.fontSize = (designSettings.fontSize * 2.1) + 'px';
                        h1.style.color = designSettings.accentColor;
                    }
                    
                    const h2s = contentDiv.querySelectorAll('h2');
                    h2s.forEach(function(h2) {
                        h2.style.fontSize = (designSettings.fontSize * 1.2) + 'px';
                        h2.style.color = designSettings.accentColor;
                    });
                    
                    const h3s = contentDiv.querySelectorAll('h3');
                    h3s.forEach(function(h3) {
                        h3.style.fontSize = (designSettings.fontSize * 1.05) + 'px';
                    });
                    
                    // Update all paragraph and span font sizes that are relative to base
                    const allElements = contentDiv.querySelectorAll('p, span, div');
                    allElements.forEach(function(el) {
                        const style = el.style;
                        // If element has a font-size that's a percentage or relative, update it
                        // Otherwise, if it's a specific px value that matches our scale, update it
                        if (style.fontSize) {
                            const fontSize = style.fontSize;
                            // Check if it's a relative size (like 1.1em, 0.95em, etc.)
                            if (fontSize.includes('em') || fontSize.includes('%')) {
                                // Keep relative sizes but ensure base is correct
                                // The base is already set on contentDiv
                            } else if (fontSize.includes('px')) {
                                const pxValue = parseFloat(fontSize);
                                // Update common relative sizes
                                if (Math.abs(pxValue - (designSettings.fontSize * 2.1)) < 1) {
                                    style.fontSize = (designSettings.fontSize * 2.1) + 'px';
                                } else if (Math.abs(pxValue - (designSettings.fontSize * 1.2)) < 1) {
                                    style.fontSize = (designSettings.fontSize * 1.2) + 'px';
                                } else if (Math.abs(pxValue - (designSettings.fontSize * 1.1)) < 1) {
                                    style.fontSize = (designSettings.fontSize * 1.1) + 'px';
                                } else if (Math.abs(pxValue - (designSettings.fontSize * 1.05)) < 1) {
                                    style.fontSize = (designSettings.fontSize * 1.05) + 'px';
                                } else if (Math.abs(pxValue - (designSettings.fontSize * 0.95)) < 1) {
                                    style.fontSize = (designSettings.fontSize * 0.95) + 'px';
                                } else if (Math.abs(pxValue - (designSettings.fontSize * 0.9)) < 1) {
                                    style.fontSize = (designSettings.fontSize * 0.9) + 'px';
                                }
                            }
                        }
                    });
                    
                    // Update section margins
                    const sections = contentDiv.querySelectorAll('div[style*="margin-bottom"]');
                    sections.forEach(function(section) {
                        if (section.style.marginBottom) {
                            section.style.marginBottom = sectionMargin + 'px';
                        }
                    });
                    
                    // Update divider classes if needed
                    const dividers = contentDiv.querySelectorAll('[class*="divider-"]');
                    dividers.forEach(function(divider) {
                        divider.className = divider.className.replace(/divider-\w+/g, dividerClass);
                    });
                }
                
                preview.innerHTML = tempDiv.innerHTML;
                
                // Save the updated HTML with new design settings back to customHTML
                // Only if we're not forcing regenerate (meaning content hasn't changed)
                if (!forceRegenerate) {
                    const updatedContentDiv = preview.querySelector('div[style*="font-family"], div[style*="font-size"]');
                    if (updatedContentDiv) {
                        const clone = updatedContentDiv.cloneNode(true);
                        clone.querySelectorAll('[contenteditable]').forEach(function(el) {
                            el.removeAttribute('contenteditable');
                        });
                        designSettings.customHTML = clone.outerHTML;
                    }
                }
                
                // Re-apply contenteditable if edit mode is enabled
                if (editModeEnabled) {
                    makeContentEditable(preview);
                }
                isRendering = false;
                setTimeout(updatePageBreakIndicator, 100);
                return;
            }

            let html = '<div style="font-family: ' + designSettings.fontFamily + '; font-size: ' + designSettings.fontSize + 'px; line-height: ' + lineHeight + '; padding: ' + designSettings.margins + 'px;">';

            // Header - CENTERED with icons
            if (p.fullName || p.email || p.phone) {
                html += '<div style="text-align: center; margin-bottom: 12px;">';
                html += '<h1 style="font-size: ' + (designSettings.fontSize * 2.1) + 'px; font-weight: bold; color: ' + designSettings.accentColor + '; margin-bottom: 4px;">' + (p.fullName || 'Your Name') + '</h1>';
                if (p.jobTitle) {
                    html += '<p style="font-size: ' + (designSettings.fontSize * 1.1) + 'px; color: #4b5563; margin-bottom: 6px;">' + p.jobTitle + '</p>';
                }
                
                let contactItems = [];
                if (p.email) contactItems.push('<span class="contact-icon"><i class="fas fa-envelope"></i> ' + p.email + '</span>');
                if (p.phone) contactItems.push('<span class="contact-icon"><i class="fas fa-phone"></i> ' + p.phone + '</span>');
                if (p.location) contactItems.push('<span class="contact-icon"><i class="fas fa-map-marker-alt"></i> ' + p.location + '</span>');
                
                if (contactItems.length > 0) {
                    html += '<div style="font-size: ' + (designSettings.fontSize * 0.95) + 'px; color: #6b7280; display: flex; justify-content: center; flex-wrap: wrap; gap: 12px;">' + contactItems.join('') + '</div>';
                }
                
                let linkItems = [];
                if (p.linkedin) linkItems.push('<span class="contact-icon"><i class="fab fa-linkedin"></i> ' + p.linkedin + '</span>');
                if (p.website) linkItems.push('<span class="contact-icon"><i class="fas fa-globe"></i> ' + p.website + '</span>');
                if (p.github) linkItems.push('<span class="contact-icon"><i class="fab fa-github"></i> ' + p.github + '</span>');
                
                if (linkItems.length > 0) {
                    html += '<div style="font-size: ' + (designSettings.fontSize * 0.95) + 'px; color: #6b7280; display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; margin-top: 4px;">' + linkItems.join('') + '</div>';
                }
                
                html += '</div>';
            }

            designSettings.sectionOrder.forEach(function(section) {
                const sectionHtml = renderSection(section, dividerClass, sectionMargin);
                if (sectionHtml) html += sectionHtml;
            });

            html += '</div>';
            preview.innerHTML = html;

            // Reset content changed flag after regenerating
            contentHasChanged = false;

            if (editModeEnabled) {
                makeContentEditable(preview);
            }
            
            isRendering = false;  // Re-enable observer after render
            // Update page break indicator after a short delay to allow DOM to render
            setTimeout(updatePageBreakIndicator, 100);
        }

        function renderSection(section, dividerClass, sectionMargin) {
            let html = '';
            const headingStyle = 'font-size: ' + (designSettings.fontSize * 1.2) + 'px; font-weight: bold; color: ' + designSettings.accentColor + '; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px;';

            if (section === 'summary' && resumeData.summary) {
                html += '<div style="margin-bottom: ' + sectionMargin + 'px;">' +
                    '<h2 style="' + headingStyle + '">' + (designSettings.sectionTitles.summary || 'Professional Summary') + '</h2>' +
                    '<div class="' + dividerClass + '"></div>' +
                    '<p style="text-align: justify; margin-top: 4px;">' + resumeData.summary + '</p>' +
                '</div>';
            }

            if (section === 'experience' && resumeData.experience.filter(function(e) { return e.enabled; }).length > 0) {
                html += '<div style="margin-bottom: ' + sectionMargin + 'px;">' +
                    '<h2 style="' + headingStyle + '">' + (designSettings.sectionTitles.experience || 'Work Experience') + '</h2>' +
                    '<div class="' + dividerClass + '"></div>';
                
                resumeData.experience.filter(function(e) { return e.enabled; }).forEach(function(exp) {
                    const endDate = exp.current ? 'Present' : formatDate(exp.endDate);
                    html += '<div style="margin-bottom: 8px; margin-top: 4px;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: baseline;">' +
                            '<h3 style="font-weight: 600; font-size: ' + (designSettings.fontSize * 1.05) + 'px;">' + exp.position + '</h3>' +
                            '<span style="font-size: ' + (designSettings.fontSize * 0.9) + 'px; color: #6b7280;">' + formatDate(exp.startDate) + ' - ' + endDate + '</span>' +
                        '</div>' +
                        '<p style="color: #4b5563;">' + exp.company + (exp.location ? ', ' + exp.location : '') + '</p>' +
                        (exp.description ? '<div style="margin-top: 4px;">' + formatBullets(exp.description) + '</div>' : '') +
                    '</div>';
                });
                
                html += '</div>';
            }

            if (section === 'education' && resumeData.education.filter(function(e) { return e.enabled; }).length > 0) {
                html += '<div style="margin-bottom: ' + sectionMargin + 'px;">' +
                    '<h2 style="' + headingStyle + '">' + (designSettings.sectionTitles.education || 'Education') + '</h2>' +
                    '<div class="' + dividerClass + '"></div>';
                
                resumeData.education.filter(function(e) { return e.enabled; }).forEach(function(edu) {
                    const endDate = edu.current ? 'Present' : formatDate(edu.endDate);
                    html += '<div style="margin-bottom: 6px; margin-top: 4px;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: baseline;">' +
                            '<h3 style="font-weight: 600; font-size: ' + (designSettings.fontSize * 1.05) + 'px;">' + edu.degree + (edu.field ? ' in ' + edu.field : '') + '</h3>' +
                            '<span style="font-size: ' + (designSettings.fontSize * 0.9) + 'px; color: #6b7280;">' + formatDate(edu.startDate) + ' - ' + endDate + '</span>' +
                        '</div>' +
                        '<p style="color: #4b5563;">' + edu.school + (edu.location ? ', ' + edu.location : '') + (edu.gpa ? '  GPA: ' + edu.gpa : '') + '</p>' +
                        (edu.achievements ? '<div style="margin-top: 4px;">' + formatBullets(edu.achievements) + '</div>' : '') +
                    '</div>';
                });
                
                html += '</div>';
            }

            if (section === 'skills' && resumeData.skills.filter(function(s) { return s.enabled; }).length > 0) {
                html += '<div style="margin-bottom: ' + sectionMargin + 'px;">' +
                    '<h2 style="' + headingStyle + '">' + (designSettings.sectionTitles.skills || 'Skills') + '</h2>' +
                    '<div class="' + dividerClass + '"></div>' +
                    '<div style="margin-top: 4px;">';
                
                resumeData.skills.filter(function(s) { return s.enabled; }).forEach(function(skill) {
                    html += '<p style="margin-bottom: 3px;"><strong>' + skill.category + ':</strong> ' + skill.skills + '</p>';
                });
                
                html += '</div></div>';
            }

            if (section === 'projects' && resumeData.projects.filter(function(p) { return p.enabled; }).length > 0) {
                html += '<div style="margin-bottom: ' + sectionMargin + 'px;">' +
                    '<h2 style="' + headingStyle + '">' + (designSettings.sectionTitles.projects || 'Projects') + '</h2>' +
                    '<div class="' + dividerClass + '"></div>';
                
                resumeData.projects.filter(function(p) { return p.enabled; }).forEach(function(proj) {
                    const endDate = proj.current ? 'Present' : formatDate(proj.endDate);
                    const dateStr = proj.startDate ? formatDate(proj.startDate) + (proj.endDate || proj.current ? ' - ' + endDate : '') : '';
                    
                    html += '<div style="margin-bottom: 6px; margin-top: 4px;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: baseline;">' +
                            '<h3 style="font-weight: 600; font-size: ' + (designSettings.fontSize * 1.05) + 'px;">' + proj.name + 
                            (proj.link ? ' <span style="font-weight: normal; font-size: ' + (designSettings.fontSize * 0.9) + 'px;">| ' + proj.link + '</span>' : '') + '</h3>' +
                            (dateStr ? '<span style="font-size: ' + (designSettings.fontSize * 0.9) + 'px; color: #6b7280;">' + dateStr + '</span>' : '') +
                        '</div>' +
                        (proj.organization ? '<p style="color: #4b5563;">' + proj.organization + '</p>' : '') +
                        (proj.technologies ? '<p style="color: #4b5563;">' + proj.technologies + '</p>' : '') +
                        (proj.description ? '<div style="margin-top: 4px;">' + formatBullets(proj.description) + '</div>' : '') +
                    '</div>';
                });
                
                html += '</div>';
            }

            if (section === 'certifications' && resumeData.certifications.filter(function(c) { return c.enabled; }).length > 0) {
                html += '<div style="margin-bottom: ' + sectionMargin + 'px;">' +
                    '<h2 style="' + headingStyle + '">' + (designSettings.sectionTitles.certifications || 'Certifications') + '</h2>' +
                    '<div class="' + dividerClass + '"></div>';
                
                resumeData.certifications.filter(function(c) { return c.enabled; }).forEach(function(cert) {
                    html += '<div style="margin-bottom: 5px; margin-top: 4px;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: baseline;">' +
                            '<span><strong>' + cert.name + '</strong> - ' + cert.issuer + '</span>' +
                            '<span style="font-size: ' + (designSettings.fontSize * 0.9) + 'px; color: #6b7280;">' + formatDate(cert.date) + '</span>' +
                        '</div>' +
                        (cert.credentialId ? '<p style="font-size: ' + (designSettings.fontSize * 0.9) + 'px; color: #6b7280;">Credential ID: ' + cert.credentialId + '</p>' : '') +
                        (cert.description ? '<div style="margin-top: 3px;">' + formatBullets(cert.description) + '</div>' : '') +
                    '</div>';
                });
                
                html += '</div>';
            }

            if (section === 'languages' && resumeData.languages.filter(function(l) { return l.enabled; }).length > 0) {
                html += '<div style="margin-bottom: ' + sectionMargin + 'px;">' +
                    '<h2 style="' + headingStyle + '">' + (designSettings.sectionTitles.languages || 'Languages') + '</h2>' +
                    '<div class="' + dividerClass + '"></div>' +
                    '<p style="margin-top: 4px;">' + resumeData.languages.filter(function(l) { return l.enabled; }).map(function(lang) { return lang.language + ' (' + lang.proficiency + ')'; }).join('  ') + '</p>' +
                '</div>';
            }

            return html;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length < 2) return dateStr;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[parseInt(parts[1]) - 1] + ' ' + parts[0];
        }

        function formatBullets(text) {
            if (!text) return '';
            // Convert HTML to plain text (one line per block) so we use a single rule: each newline = one bullet
            var plain = text;
            if (text.includes('<') && text.includes('>')) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                plain = tempDiv.innerText || '';
            }
            return plain.split('\n').map(function(line) {
                var trimmed = line.trim();
                if (!trimmed) return '';
                var cleanLine = trimmed.replace(/^[\-\*]\s*/, '');
                return '<div style="padding-left: 12px; text-indent: -12px;"> ' + escapeHtml(cleanLine) + '</div>';
            }).filter(function(line) { return line; }).join('');
        }

        // ==================== PAGE BREAK INDICATOR ====================
        function updatePageBreakIndicator() {
            const preview = document.getElementById('resumePreview');
            const content = preview.querySelector('div');
            if (!content) return;
            
            // Create a hidden measurement container with exact A4 dimensions
            // This ensures accurate page counting regardless of screen size
            const measurementContainer = document.createElement('div');
            measurementContainer.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 794px; visibility: hidden; overflow: visible; background: white;';
            
            // Clone the content with all its styles and computed styles
            const contentClone = content.cloneNode(true);
            
            // Copy computed styles to ensure accurate rendering
            const computedStyle = window.getComputedStyle(content);
            const cloneStyle = contentClone.style;
            cloneStyle.fontFamily = computedStyle.fontFamily;
            cloneStyle.fontSize = computedStyle.fontSize;
            cloneStyle.lineHeight = computedStyle.lineHeight;
            cloneStyle.padding = computedStyle.padding;
            cloneStyle.margin = computedStyle.margin;
            
            measurementContainer.appendChild(contentClone);
            document.body.appendChild(measurementContainer);
            
            // Force a reflow to ensure accurate measurement
            void measurementContainer.offsetHeight;
            
            // Get the actual rendered height at A4 width (794px)
            const contentHeightAtA4 = contentClone.scrollHeight;
            
            // Clean up
            document.body.removeChild(measurementContainer);
            
            // A4 dimensions at 96 DPI
            const a4HeightPx = 1123; // 297mm
            
            // Usable page height: A4 height minus top and bottom margins
            const usablePageHeight = a4HeightPx - (designSettings.margins * 2);
            
            // Calculate number of pages (round up)
            const numPages = Math.ceil(contentHeightAtA4 / usablePageHeight);
            
            // Remove existing page break indicators
            preview.querySelectorAll('.page-break-indicator').forEach(function(el) {
                el.remove();
            });
            
            // Calculate scale factor for positioning indicators in preview
            const previewWidth = preview.offsetWidth;
            if (!previewWidth) return numPages;
            const a4WidthPx = 794;
            const scaleFactor = previewWidth / a4WidthPx;
            
            // Add page break indicators
            for (let i = 1; i < numPages && i < 4; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'page-break-indicator' + (i > 1 ? ' page-' + (i + 1) : '');
                // Position indicator: (usable height * page number) + top margin, scaled to preview
                const breakTopPhysical = (usablePageHeight * i) + designSettings.margins;
                indicator.style.top = (breakTopPhysical * scaleFactor) + 'px';
                preview.appendChild(indicator);
            }
            
            // Update page count badge
            const pageCountEl = document.getElementById('pageCount');
            if (pageCountEl) {
                pageCountEl.textContent = numPages + (numPages === 1 ? ' page' : ' pages');
            }
            
            // Show/hide overflow warning
            const warningEl = document.getElementById('pageOverflowWarning');
            const overflowPagesEl = document.getElementById('overflowPages');
            if (warningEl && overflowPagesEl) {
                if (numPages > 1) {
                    warningEl.classList.remove('hidden');
                    overflowPagesEl.textContent = numPages;
                } else {
                    warningEl.classList.add('hidden');
                }
            }
            
            return numPages;
        }

        function autoFitToPage() {
            const preview = document.getElementById('resumePreview');
            const content = preview.querySelector('div');
            if (!content) return;
            
            showNotification('Auto-fitting resume to one page...', 'info');
            
            // Store original settings for potential rollback
            const originalSettings = JSON.parse(JSON.stringify(designSettings));
            
            // Try progressively more aggressive adjustments
            const adjustmentSteps = [
                // Step 1: Reduce section spacing
                function() {
                    if (designSettings.sectionSpacing > 6) {
                        designSettings.sectionSpacing = Math.max(6, designSettings.sectionSpacing - 2);
                        return true;
                    }
                    return false;
                },
                // Step 2: Reduce line spacing
                function() {
                    if (designSettings.lineSpacing > 1.1) {
                        designSettings.lineSpacing = Math.max(1.1, designSettings.lineSpacing - 0.1);
                        return true;
                    }
                    return false;
                },
                // Step 3: Reduce font size
                function() {
                    if (designSettings.fontSize > 9) {
                        designSettings.fontSize = Math.max(9, designSettings.fontSize - 0.5);
                        return true;
                    }
                    return false;
                },
                // Step 4: Reduce margins
                function() {
                    if (designSettings.margins > 12) {
                        designSettings.margins = Math.max(12, designSettings.margins - 4);
                        return true;
                    }
                    return false;
                },
                // Step 5: Switch to compact layout
                function() {
                    if (designSettings.layout !== 'compact') {
                        designSettings.layout = 'compact';
                        return true;
                    }
                    return false;
                }
            ];
            
            let attempts = 0;
            const maxAttempts = 30;
            
            function tryAdjustment() {
                renderResume();
                // Wait for DOM to render before measuring
                setTimeout(function() {
                    const pages = updatePageBreakIndicator();
                
                    if (pages <= 1 || attempts >= maxAttempts) {
                        // Update UI controls to reflect new settings
                        document.getElementById('fontSize').value = designSettings.fontSize;
                        document.getElementById('lineSpacing').value = designSettings.lineSpacing;
                        document.getElementById('margins').value = designSettings.margins;
                        document.getElementById('sectionSpacing').value = designSettings.sectionSpacing;
                        document.getElementById('fontSizeValue').textContent = designSettings.fontSize + 'px';
                        document.getElementById('lineSpacingValue').textContent = designSettings.lineSpacing.toFixed(1);
                        document.getElementById('marginsValue').textContent = designSettings.margins + 'px';
                        document.getElementById('sectionSpacingValue').textContent = designSettings.sectionSpacing + 'px';
                        
                        // Update layout button
                        document.querySelectorAll('.layout-btn').forEach(function(btn) {
                            btn.classList.remove('border-blue-500', 'bg-blue-50');
                            if (btn.dataset.layout === designSettings.layout) {
                                btn.classList.add('border-blue-500', 'bg-blue-50');
                            }
                        });
                        
                        triggerAutoSave();
                        
                        if (pages <= 1) {
                            showNotification('Resume fitted to 1 page successfully!', 'success');
                        } else {
                            showNotification('Could not fit to 1 page. Consider removing some content.', 'error');
                        }
                        return;
                    }
                    
                    // Try each adjustment step
                    let adjusted = false;
                    for (let i = 0; i < adjustmentSteps.length; i++) {
                        if (adjustmentSteps[i]()) {
                            adjusted = true;
                            break;
                        }
                    }
                    
                    if (!adjusted) {
                        // All adjustments exhausted
                        showNotification('Could not fit to 1 page. Consider removing some content.', 'error');
                        return;
                    }
                    
                    attempts++;
                    setTimeout(tryAdjustment, 50);
                }, 100);
            }
            
            tryAdjustment();
        }

        // ==================== SCORING ====================
        function calculateAllScores() {
            const scores = {
                personal: calculatePersonalScore(),
                summary: calculateSummaryScore(),
                experience: calculateExperienceScore(),
                education: calculateEducationScore(),
                skills: calculateSkillsScore(),
                projects: calculateProjectsScore(),
                certifications: calculateCertificationsScore(),
                languages: calculateLanguagesScore()
            };

            Object.keys(scores).forEach(function(key) {
                const el = document.getElementById('score-' + key);
                if (el) {
                    el.textContent = scores[key] + '%';
                    el.className = 'text-xs px-2 py-1 rounded-full ' + getScoreColor(scores[key]);
                }
            });

            const weights = { personal: 15, summary: 10, experience: 30, education: 15, skills: 15, projects: 10, certifications: 3, languages: 2 };
            let totalScore = 0, totalWeight = 0;
            Object.keys(scores).forEach(function(key) {
                totalScore += scores[key] * weights[key];
                totalWeight += weights[key];
            });
            const finalScore = Math.round(totalScore / totalWeight);

            const scoreCircle = document.getElementById('scoreCircle');
            const totalScoreEl = document.getElementById('totalScore');
            if (scoreCircle && totalScoreEl) {
                const offset = 352 - (finalScore / 100) * 352;
                scoreCircle.style.strokeDashoffset = offset;
                scoreCircle.style.stroke = finalScore >= 70 ? '#22c55e' : finalScore >= 40 ? '#f59e0b' : '#ef4444';
                totalScoreEl.textContent = finalScore + '%';
            }

            return scores;
        }

        function calculatePersonalScore() {
            const p = resumeData.personal;
            let score = 0;
            if (p.fullName) score += 25;
            if (p.email) score += 25;
            if (p.phone) score += 20;
            if (p.location) score += 10;
            if (p.linkedin) score += 10;
            if (p.website || p.github) score += 10;
            return Math.min(score, 100);
        }

        function calculateSummaryScore() {
            const summary = resumeData.summary;
            if (!summary) return 0;
            let score = 0;
            if (summary.length >= 50) score += 30;
            if (summary.length >= 100) score += 20;
            if (summary.length >= 150 && summary.length <= 400) score += 30;
            if (summary.length > 400) score -= 10;
            const actionWords = ['achieved', 'led', 'developed', 'created', 'managed', 'improved', 'increased', 'reduced', 'delivered', 'implemented'];
            actionWords.forEach(function(word) { if (summary.toLowerCase().includes(word)) score += 2; });
            return Math.min(Math.max(score, 0), 100);
        }

        function calculateExperienceScore() {
            const exp = resumeData.experience.filter(function(e) { return e.enabled; });
            if (exp.length === 0) return 0;
            let score = 0;
            exp.forEach(function(e) {
                if (e.position) score += 10;
                if (e.company) score += 10;
                if (e.startDate) score += 5;
                if (e.description) {
                    score += 15;
                    if (e.description.includes('') || e.description.includes('-') || e.description.includes('\n')) score += 5;
                    if (/\d+%|\d+\s*(users|customers|clients|projects|team|members)/i.test(e.description)) score += 10;
                }
            });
            return Math.min(Math.round(score / exp.length), 100);
        }

        function calculateEducationScore() {
            const edu = resumeData.education.filter(function(e) { return e.enabled; });
            if (edu.length === 0) return 0;
            let score = 0;
            edu.forEach(function(e) {
                if (e.school) score += 25;
                if (e.degree) score += 25;
                if (e.field) score += 15;
                if (e.startDate && (e.endDate || e.current)) score += 10;
                if (e.gpa) score += 10;
                if (e.achievements) score += 15;
            });
            return Math.min(Math.round(score / edu.length), 100);
        }

        function calculateSkillsScore() {
            const skills = resumeData.skills.filter(function(s) { return s.enabled; });
            if (skills.length === 0) return 0;
            let score = skills.length >= 1 ? 40 : 0;
            score += skills.length >= 2 ? 20 : 0;
            score += skills.length >= 3 ? 20 : 0;
            skills.forEach(function(s) { if (s.skills && s.skills.split(',').length >= 3) score += 5; });
            return Math.min(score, 100);
        }

        function calculateProjectsScore() {
            const proj = resumeData.projects.filter(function(p) { return p.enabled; });
            if (proj.length === 0) return 0;
            let score = proj.length >= 1 ? 30 : 0;
            score += proj.length >= 2 ? 20 : 0;
            proj.forEach(function(p) {
                if (p.name) score += 10;
                if (p.technologies) score += 10;
                if (p.description) score += 15;
                if (p.link) score += 5;
            });
            return Math.min(Math.round(score / proj.length), 100);
        }

        function calculateCertificationsScore() {
            const certs = resumeData.certifications.filter(function(c) { return c.enabled; });
            if (certs.length === 0) return 50;
            return Math.min(50 + certs.length * 25, 100);
        }

        function calculateLanguagesScore() {
            const langs = resumeData.languages.filter(function(l) { return l.enabled; });
            if (langs.length === 0) return 50;
            return Math.min(50 + langs.length * 25, 100);
        }

        function getScoreColor(score) {
            if (score >= 70) return 'bg-green-100 text-green-700';
            if (score >= 40) return 'bg-yellow-100 text-yellow-700';
            return 'bg-red-100 text-red-700';
        }

        function renderScoreBreakdown() {
            const scores = calculateAllScores();
            const container = document.getElementById('scoreBreakdown');
            const tips = document.getElementById('scoreTips');

            const sectionInfo = {
                personal: { name: 'Personal Information', icon: 'fa-user' },
                summary: { name: 'Professional Summary', icon: 'fa-align-left' },
                experience: { name: 'Work Experience', icon: 'fa-briefcase' },
                education: { name: 'Education', icon: 'fa-graduation-cap' },
                skills: { name: 'Skills', icon: 'fa-cogs' },
                projects: { name: 'Projects', icon: 'fa-project-diagram' },
                certifications: { name: 'Certifications', icon: 'fa-certificate' },
                languages: { name: 'Languages', icon: 'fa-language' }
            };

            container.innerHTML = Object.keys(scores).map(function(key) {
                const info = sectionInfo[key];
                const score = scores[key];
                const colorClass = score >= 70 ? 'bg-green-500' : score >= 40 ? 'bg-yellow-500' : 'bg-red-500';
                const textColor = score >= 70 ? 'text-green-600' : score >= 40 ? 'text-yellow-600' : 'text-red-600';
                
                return '<div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">' +
                    '<i class="fas ' + info.icon + ' text-gray-400 w-5"></i>' +
                    '<div class="flex-1">' +
                        '<div class="flex justify-between items-center mb-1">' +
                            '<span class="text-sm font-medium">' + info.name + '</span>' +
                            '<span class="text-sm ' + textColor + '">' + score + '%</span>' +
                        '</div>' +
                        '<div class="w-full bg-gray-200 rounded-full h-2">' +
                            '<div class="h-2 rounded-full ' + colorClass + '" style="width: ' + score + '%"></div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');

            let tipsList = [];
            if (scores.personal < 70) tipsList.push(' Add all contact information including LinkedIn');
            if (scores.summary < 70) tipsList.push(' Write a compelling summary with action words');
            if (scores.experience < 70) tipsList.push(' Add quantifiable achievements to your experience');
            if (scores.education < 70) tipsList.push(' Complete your education details');
            if (scores.skills < 70) tipsList.push(' Add 2-3 skill categories');
            if (scores.projects < 50) tipsList.push(' Add relevant projects');
            
            tips.innerHTML = tipsList.length > 0 ? tipsList.join('<br>') : ' Great job! Your resume is well-optimized.';
        }

        // ==================== EXPORT ====================
        function toggleExportMenu() {
            document.getElementById('exportMenu').classList.toggle('hidden');
        }

        document.addEventListener('click', function(e) {
            const menu = document.getElementById('exportMenu');
            const btn = e.target.closest('button');
            if (!btn || !btn.onclick || btn.onclick.toString().indexOf('toggleExportMenu') === -1) {
                if (!e.target.closest('#exportMenu')) {
                    if (menu) menu.classList.add('hidden');
                }
            }
        });

        function exportToPDF() {
            toggleExportMenu();
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.innerHTML = '<div class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center">' +
                '<div class="bg-white rounded-xl p-8 text-center shadow-2xl">' +
                    '<div class="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>' +
                    '<p class="text-lg font-medium text-gray-700">Generating PDF...</p>' +
                '</div></div>';
            document.body.appendChild(loadingOverlay);

            const element = document.getElementById('resumePreview');
            const clone = element.cloneNode(true);
            clone.querySelectorAll('[contenteditable]').forEach(function(el) { el.removeAttribute('contenteditable'); });
            // Remove preview container padding for PDF export
            // clone.style.padding = '0';
            // clone.style.minHeight = '297mm';
            
            const container = document.createElement('div');
            container.style.cssText = 'position:absolute;left:-9999px;top:0;width:210mm;background:white;';
            container.appendChild(clone);
            document.body.appendChild(container);

            html2pdf().set({
                margin: [0, 0, 0, 0],
                filename: (resumeData.personal.fullName || 'Resume') + '_Resume.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, useCORS: true, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(clone).save().then(function() {
                document.body.removeChild(container);
                document.body.removeChild(loadingOverlay);
            });
        }

        function exportToHTML() {
            const element = document.getElementById('resumePreview');
            const blob = new Blob(['<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + (resumeData.personal.fullName || 'Resume') + '</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></head><body style="margin:0;padding:20px;background:#f3f4f6;"><div style="max-width:210mm;margin:0 auto;background:white;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">' + element.innerHTML + '</div></body></html>'], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (resumeData.personal.fullName || 'resume') + '_resume.html';
            a.click();
            toggleExportMenu();
        }

        function exportToTXT() {
            let text = '';
            const p = resumeData.personal;
            text += (p.fullName || 'Your Name') + '\n';
            if (p.jobTitle) text += p.jobTitle + '\n';
            text += [p.email, p.phone, p.location].filter(Boolean).join(' | ') + '\n\n';
            if (resumeData.summary) text += 'PROFESSIONAL SUMMARY\n' + resumeData.summary + '\n\n';
            
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (resumeData.personal.fullName || 'resume') + '_resume.txt';
            a.click();
            toggleExportMenu();
        }

        function printToPDF() {
            toggleExportMenu();
            const printWindow = window.open('', '_blank');
            const resumeContent = document.getElementById('resumePreview').innerHTML;
            
            printWindow.document.write('<!DOCTYPE html><html><head><title>' + (resumeData.personal.fullName || 'Resume') + '</title>' +
                '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">' +
                '<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:' + designSettings.fontFamily + ';background:white}' +
                '.resume-content{width:210mm;min-height:297mm;margin:0 auto;padding:0}' +
                '.contact-icon{display:inline-flex;align-items:center;gap:4px}.contact-icon i{font-size:0.85em}' +
                '.divider-line{border-bottom:1px solid #333;margin:4px 0}.divider-double{border-bottom:3px double #333;margin:4px 0}' +
                '.divider-dashed{border-bottom:1px dashed #333;margin:4px 0}.divider-dotted{border-bottom:2px dotted #333;margin:4px 0}' +
                '.divider-thick{border-bottom:2px solid #333;margin:4px 0}' +
                '@media print{@page{size:A4;margin:0}.print-tip{display:none!important}}' +
                '@media screen{body{padding:20px;background:#f0f0f0}.resume-content{box-shadow:0 0 10px rgba(0,0,0,0.1)}' +
                '.print-tip{max-width:210mm;margin:0 auto 20px;padding:15px;background:#e8f4fd;border-radius:8px;border-left:4px solid #3b82f6}}' +
                '</style></head><body>' +
                '<div class="print-tip"><strong>Tip:</strong> Press Ctrl+P and select "Save as PDF"</div>' +
                '<div class="resume-content">' + resumeContent + '</div></body></html>');
            printWindow.document.close();
            printWindow.onload = function() { setTimeout(function() { printWindow.print(); }, 500); };
        }

        // ==================== SAVE/LOAD ====================
        function openSaveModal() {
            document.getElementById('saveModal').classList.remove('hidden');
            document.getElementById('resumeName').value = resumeData.personal.fullName ? resumeData.personal.fullName + "'s Resume" : 'My Resume';
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.add('hidden');
        }

        async function saveResumeWithName() {
            const name = document.getElementById('resumeName').value || 'My Resume';
            
            try {
                await saveResumeToDatabase(name);
                closeSaveModal();
                showNotification('Resume "' + name + '" saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving resume:', error);
                showNotification('Error saving resume. Please try again.', 'error');
            }
        }

        function openLoadModal() {
            document.getElementById('loadModal').classList.remove('hidden');
            renderSavedResumes();
        }

        function closeLoadModal() {
            document.getElementById('loadModal').classList.add('hidden');
        }

        async function renderSavedResumes() {
            const container = document.getElementById('savedResumesList');
            
            // Show loading state
            container.innerHTML = '<div class="text-center py-12 text-gray-400">' +
                '<i class="fas fa-spinner fa-spin text-4xl mb-3"></i>' +
                '<p>Loading your resumes...</p>' +
            '</div>';
            
            try {
                const savedResumes = await getAllResumesFromDatabase();
                
                if (savedResumes.length === 0) {
                    container.innerHTML = '<div class="text-center py-12 text-gray-400">' +
                        '<i class="fas fa-folder-open text-4xl mb-3"></i>' +
                        '<p>No saved resumes yet</p>' +
                        '<p class="text-sm">Click "Save" to save your current resume</p>' +
                    '</div>';
                    return;
                }
                
                container.innerHTML = savedResumes.map(function(resume) {
                    const date = new Date(resume.date).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const personalName = resume.resumeData.personal.fullName || 'Unnamed';
                    const experienceCount = resume.resumeData.experience ? resume.resumeData.experience.length : 0;
                    const educationCount = resume.resumeData.education ? resume.resumeData.education.length : 0;
                    
                    return '<div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 mb-3 transition-colors">' +
                        '<div class="flex items-center gap-4">' +
                            '<div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">' +
                                '<i class="fas fa-file-alt text-white text-xl"></i>' +
                            '</div>' +
                            '<div>' +
                                '<h4 class="font-semibold text-gray-800">' + resume.name + '</h4>' +
                                '<p class="text-sm text-gray-500">' + personalName + '</p>' +
                                '<p class="text-xs text-gray-400">' + date + '  ' + experienceCount + ' experience, ' + educationCount + ' education</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-2">' +
                            '<button onclick="loadResume(' + resume.id + ')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-medium transition-colors">' +
                                '<i class="fas fa-folder-open mr-1"></i> Load' +
                            '</button>' +
                            '<button onclick="renameResume(' + resume.id + ', \'' + escapeHtml(resume.name).replace(/'/g, "\\'") + '\')" class="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm" title="Rename">' +
                                '<i class="fas fa-pen"></i>' +
                            '</button>' +
                            '<button onclick="duplicateResume(' + resume.id + ')" class="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm" title="Duplicate">' +
                                '<i class="fas fa-copy"></i>' +
                            '</button>' +
                            '<button onclick="deleteResume(' + resume.id + ')" class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-lg text-sm" title="Delete">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch (error) {
                console.error('Error loading resumes:', error);
                container.innerHTML = '<div class="text-center py-12 text-red-400">' +
                    '<i class="fas fa-exclamation-circle text-4xl mb-3"></i>' +
                    '<p>Error loading resumes</p>' +
                    '<p class="text-sm">Please refresh the page and try again</p>' +
                '</div>';
            }
        }

        async function loadResume(id) {
            try {
                const resume = await loadResumeFromDatabase(id);
                
                resumeData = resume.resumeData;
                designSettings = resume.designSettings;
                
                populateFormFromData();
                autoSaveState();
                closeLoadModal();
                
                showNotification('Resume "' + resume.name + '" loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading resume:', error);
                showNotification('Error loading resume. Please try again.', 'error');
            }
        }

        async function duplicateResume(id) {
            try {
                const resume = await loadResumeFromDatabase(id);
                await saveResumeToDatabase(resume.name + ' (Copy)');
                renderSavedResumes();
                showNotification('Resume duplicated successfully!', 'success');
            } catch (error) {
                console.error('Error duplicating resume:', error);
                showNotification('Error duplicating resume.', 'error');
            }
        }

        async function deleteResume(id) {
            if (confirm('Are you sure you want to delete this resume? This cannot be undone.')) {
                try {
                    await deleteResumeFromDatabase(id);
                    renderSavedResumes();
                    showNotification('Resume deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting resume:', error);
                    showNotification('Error deleting resume.', 'error');
                }
            }
        }

        async function renameResume(id, currentName) {
            const newName = prompt('Enter a new name for this resume:', currentName);
            
            if (newName === null) {
                // User cancelled
                return;
            }
            
            if (newName.trim() === '') {
                showNotification('Resume name cannot be empty.', 'error');
                return;
            }
            
            try {
                // Get the existing resume from database
                const resume = await loadResumeFromDatabase(id);
                
                // Update with new name
                const transaction = db.transaction(['resumes'], 'readwrite');
                const store = transaction.objectStore('resumes');
                
                const updatedResume = {
                    id: id,
                    name: newName.trim(),
                    date: resume.date, // Keep original date
                    resumeData: resume.resumeData,
                    designSettings: resume.designSettings
                };
                
                store.put(updatedResume);
                
                transaction.oncomplete = function() {
                    renderSavedResumes();
                    showNotification('Resume renamed to "' + newName.trim() + '"!', 'success');
                };
                
                transaction.onerror = function(event) {
                    console.error('Error renaming resume:', event.target.error);
                    showNotification('Error renaming resume.', 'error');
                };
            } catch (error) {
                console.error('Error renaming resume:', error);
                showNotification('Error renaming resume.', 'error');
            }
        }

        // Clear all data (for debugging/reset)
        async function clearAllData() {
            if (confirm('This will delete ALL saved resumes and reset the application. Are you sure?')) {
                try {
                    const transaction = db.transaction(['resumes', 'currentState'], 'readwrite');
                    transaction.objectStore('resumes').clear();
                    transaction.objectStore('currentState').clear();
                    
                    // Reset to defaults
                    resumeData = {
                        personal: { fullName: '', jobTitle: '', email: '', phone: '', location: '', linkedin: '', website: '', github: '' },
                        summary: '',
                        experience: [],
                        education: [],
                        skills: [],
                        projects: [],
                        certifications: [],
                        languages: []
                    };
                    
                    designSettings = {
                        fontFamily: "'Open Sans', sans-serif",
                        fontSize: 11,
                        lineSpacing: 1.4,
                        margins: 20,
                        sectionSpacing: 12,
                        dividerStyle: 'line',
                        layout: 'single',
                        accentColor: '#000000',
                        sectionOrder: ['summary', 'experience', 'education', 'skills', 'projects', 'certifications', 'languages']
                    };
                    
                    populateFormFromData();
                    showNotification('All data cleared successfully!', 'success');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showNotification('Error clearing data.', 'error');
                }
            }
        }
    </script>
</body>
</html>
